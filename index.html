<button id="recordBtn">Grabar</button>
<p id="status"></p>
<script>
let mediaRecorder;
let audioChunks = [];

const recordBtn = document.getElementById("recordBtn");
const status = document.getElementById("status");

recordBtn.addEventListener("click", async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      status.textContent = "Enviando audio...";
      const blob = new Blob(audioChunks, { type: "audio/webm" });

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Audio = reader.result.split(",")[1]; // sacamos 'data:audio/webm;base64,'

        try {
          const res = await fetch("/.netlify/functions/transcribe", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: base64Audio,
          });
          const data = await res.json();
          console.log(data);
          status.textContent = "Texto: " + data.text;
        } catch (err) {
          console.error(err);
          status.textContent = "Error al enviar audio";
        }
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    status.textContent = "Grabando...";
    recordBtn.textContent = "Detener";
  } else if (mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordBtn.textContent = "Grabar";
  }
});
</script>
