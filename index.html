<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Automatic Life</title>

<!-- Google Identity -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #00ffea;
  --primary-dark: #00c4b4;
  --bg-dark: #0f0c29;
  --bg-mid: #302b63;
  --bg-light: #24243e;
  --danger: #ff6b6b;
  --warning: #ffc107;
  --glass: rgba(0, 255, 234, 0.05);
  --glass-border: rgba(0, 255, 234, 0.2);
}

body {
  margin: 0;
  min-height: 100vh;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, var(--bg-dark), var(--bg-mid), var(--bg-light));
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  color: var(--primary);
  overflow-x: hidden;
  position: relative;
}

/* ===== ICONOS SVG ===== */
.icon {
  width: 24px;
  height: 24px;
  fill: none;
  stroke: currentColor;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  flex-shrink: 0;
}

.icon-small { width: 24px; height: 24px; }
.icon-large { width: 24px; height: 24px; }

/* ===== HEADER ===== */
#header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  background: linear-gradient(to bottom, rgba(15, 12, 41, 0.9), transparent);
}

#logo {
  font-size: 1.3rem;
  font-weight: bold;
  letter-spacing: 2px;
  background: linear-gradient(to right, var(--primary), var(--primary-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#userSection {
  display: flex;
  align-items: center;
  gap: 10px;
}

#userPanel {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 25px;
  transition: all 0.3s;
  font-size: 0.85rem;
}

#userPanel:hover {
  background: rgba(0, 255, 234, 0.1);
  border-color: var(--primary);
}

#userAvatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--bg-dark);
  font-weight: bold;
  font-size: 0.8rem;
}

.planBadge {
  background: rgba(0, 255, 234, 0.15);
  padding: 3px 8px;
  border-radius: 10px;
  border: 1px solid var(--primary);
  font-size: 0.65rem;
  font-weight: bold;
  text-transform: uppercase;
}

/* ===== USER MENU ===== */
#userMenu {
  position: absolute;
  top: 60px;
  right: 20px;
  background: rgba(15, 12, 41, 0.98);
  border: 1px solid var(--primary);
  border-radius: 16px;
  padding: 12px;
  min-width: 220px;
  backdrop-filter: blur(20px);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
  z-index: 200;
  transform-origin: top right;
  animation: menuAppear 0.2s ease;
}

@keyframes menuAppear {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.menuItem {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 4px;
  font-size: 0.9rem;
}

.menuItem:hover {
  background: rgba(0, 255, 234, 0.1);
}

.menuItem:last-child {
  margin-bottom: 0;
  color: var(--danger);
}

.menuItem:last-child:hover {
  background: rgba(255, 107, 107, 0.1);
}

.menuDivider {
  height: 1px;
  background: var(--glass-border);
  margin: 8px 0;
}

/* ===== MAIN CONTENT ===== */
#mainContent {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 80px 20px 140px;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  position: relative;
}

/* ===== RESULT PANEL ===== */
#resultPanel {
  flex: 1;
  min-height: 200px;
  max-height: calc(80vh - 300px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  padding: 20px;
  overflow-y: auto;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

#resultPanel.show {
  opacity: 1;
  transform: translateY(0);
}

#resultPanel::-webkit-scrollbar {
  width: 6px;
}

#resultPanel::-webkit-scrollbar-track {
  background: rgba(0, 255, 234, 0.05);
  border-radius: 3px;
}

#resultPanel::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 3px;
}

.result-content {
  line-height: 1.6;
  font-size: 1rem;
}

/* ===== TRANSCRIBED TEXT ===== */
#transcribedContainer {
  text-align: center;
  padding: 15px;
  opacity: 0.7;
  font-style: italic;
  font-size: 0.9rem;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== CENTER BUTTON (GO) ===== */
#centerArea {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 50;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  pointer-events: none;
}

#aiCore {
  position: relative;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--primary) 0%, var(--primary-dark) 70%, #003a38 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  box-shadow:
    0 0 40px rgba(0, 255, 234, 0.6),
    0 0 80px rgba(0, 255, 234, 0.3),
    inset 0 0 30px rgba(255, 255, 255, 0.3);
  transition: all 0.3s ease;
  user-select: none;
  pointer-events: all;
}

#aiCore:hover {
  transform: scale(1.08);
  box-shadow:
    0 0 60px rgba(0, 255, 234, 0.8),
    0 0 100px rgba(0, 255, 234, 0.4);
}

#aiCore:active {
  transform: scale(0.95);
}

#coreText {
  color: var(--bg-dark);
  font-weight: bold;
  font-size: 1.3rem;
  letter-spacing: 3px;
  pointer-events: none;
}

.pulseRing {
  position: absolute;
  width: 100%;
  height: 100%;
  border: 2px solid var(--primary);
  border-radius: 50%;
  opacity: 0;
  pointer-events: none;
}

.ai-active .pulseRing {
  animation: pulseWave 1.5s infinite;
}

.pulseRing:nth-child(1) { animation-delay: 0s; }
.pulseRing:nth-child(2) { animation-delay: 0.5s; }
.pulseRing:nth-child(3) { animation-delay: 1s; }

@keyframes pulseWave {
  0% { transform: scale(1); opacity: 0.8; }
  100% { transform: scale(2.2); opacity: 0; }
}

.hint-text {
  font-size: 0.8rem;
  opacity: 0;
  text-align: center;
  max-width: 200px;
  pointer-events: none;
  transition: opacity 0.5s ease;
  position: absolute;
  bottom: -40px;
}

.hint-text.visible {
  opacity: 0.6;
}

.hint-text.fade-out {
  opacity: 0;
}

/* ===== BOTTOM BAR ===== */
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(15, 12, 41, 0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--glass-border);
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 100;
}

#quickActions {
  display: flex;
  gap: 8px;
}

.quickBtn {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  color: var(--primary);
  padding: 10px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.quickBtn:hover {
  background: rgba(0, 255, 234, 0.15);
  border-color: var(--primary);
  transform: translateY(-2px);
}

#textFAB {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary);
  color: var(--bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 255, 234, 0.5);
  transition: all 0.3s;
  flex-shrink: 0;
}

#textFAB:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 0 30px rgba(0, 255, 234, 0.7);
}

#notifBtn {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: var(--glass);
  border: 2px solid var(--glass-border);
  color: var(--primary);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s;
  flex-shrink: 0;
}

#notifBtn:hover {
  background: rgba(0, 255, 234, 0.15);
  transform: scale(1.1);
}

#notifBtn.granted {
  background: var(--primary);
  color: var(--bg-dark);
  border-color: var(--primary);
}

/* ===== MODAL ===== */
#textModal {
  position: fixed;
  inset: 0;
  background: rgba(5, 10, 25, 0.9);
  backdrop-filter: blur(20px);
  justify-content: center;
  align-items: flex-end;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  padding: 20px;
}

#textModal:not(.hidden) {
  display: flex;
  opacity: 1;
  pointer-events: all;
}

#textBox {
  background: rgba(15, 12, 41, 0.98);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 25px;
  width: 100%;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  box-shadow: 0 -10px 60px rgba(0, 0, 0, 0.8);
  transform: translateY(20px);
  transition: transform 0.3s;
  margin-bottom: env(safe-area-inset-bottom, 0);
}

#textModal:not(.hidden) #textBox {
  transform: translateY(0);
}

.modalHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modalTitle {
  font-size: 1.1rem;
  font-weight: 600;
}

#closeModal {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  padding: 5px;
  border-radius: 50%;
  transition: background 0.2s;
}

#closeModal:hover {
  background: rgba(0, 255, 234, 0.1);
}

#textInput {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 16px;
  color: var(--primary);
  font-size: 16px;
  resize: none;
  outline: none;
  height: 120px;
  font-family: inherit;
  transition: all 0.3s;
  line-height: 1.5;
}

#textInput::placeholder {
  color: rgba(0, 255, 234, 0.4);
}

#textInput:focus {
  border-color: var(--primary);
  box-shadow: 0 0 20px rgba(0, 255, 234, 0.2);
  background: rgba(0, 0, 0, 0.5);
}

#sendTextBtn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border: none;
  border-radius: 12px;
  padding: 16px;
  font-weight: bold;
  letter-spacing: 1px;
  color: var(--bg-dark);
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 255, 234, 0.4);
  transition: all 0.3s;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#sendTextBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 30px rgba(0, 255, 234, 0.6);
}

#sendTextBtn:active {
  transform: translateY(0);
}

/* ===== COMPONENTS ===== */
.loading-dots {
  display: inline-flex;
  gap: 4px;
}

.loading-dots span {
  animation: bounce 1.4s infinite ease-in-out both;
  background: var(--bg-dark);
  border-radius: 50%;
  width: 8px;
  height: 8px;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

.reminder-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(255, 193, 7, 0.15);
  border: 1px solid var(--warning);
  color: var(--warning);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  margin-top: 10px;
  width: fit-content;
}

.edit-btn {
  margin-top: 15px;
  padding: 10px 24px;
  border-radius: 20px;
  border: none;
  background: var(--primary);
  cursor: pointer;
  font-weight: bold;
  color: var(--bg-dark);
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.edit-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(0, 255, 234, 0.5);
}

#loginHint {
  position: fixed;
  top: 75%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  padding: 20px 10px;
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 16px;
  color: var(--danger);
  font-size: 0.75rem;
  max-width: 300px;
  z-index: 40;
}

.hidden { display: none !important; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  #header {
    padding: 12px 15px;
  }
  
  #logo {
    font-size: 1.1rem;
  }
  
  #mainContent {
    padding: 70px 15px 160px;
  }
  
  #resultPanel {
    min-height: 150px;
    max-height: calc(80vh - 280px);
    padding: 15px;
    border-radius: 16px;
  }
  
  #aiCore {
    width: 90px;
    height: 90px;
  }
  
  #coreText {
    font-size: 1.1rem;
  }
  
  #bottomBar {
    padding: 12px 15px;
    gap: 10px;
  }
  
  .quickBtn {
    padding: 8px 12px;
    font-size: 0.75rem;
  }
  
  .quickBtn span {
    display: none;
  }
  
  #textFAB {
    width: 45px;
    height: 45px;
  }
  
  #notifBtn {
    width: 40px;
    height: 40px;
  }
  
  #userMenu {
    right: 15px;
    min-width: 200px;
  }
}

@media (max-width: 480px) {
  #quickActions {
    gap: 6px;
  }
  
  .quickBtn {
    padding: 8px;
  }
  
  .quickBtn svg {
    width: 24px;
    height: 24px;
  }
  
  #textBox {
    padding: 20px;
    border-radius: 20px 20px 0 0;
  }
}

@media (min-width: 769px) {
  #bottomBar {
    max-width: 800px;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 30px 30px 0 0;
    border: 1px solid var(--glass-border);
    border-bottom: none;
  }
  
  #mainContent {
    padding-bottom: 120px;
  }
}

/* Safe area for notched phones */
@supports (padding: max(0px)) {
  #header {
    padding-top: max(15px, env(safe-area-inset-top));
  }
  
  #bottomBar {
    padding-bottom: max(15px, env(safe-area-inset-bottom));
  }
}
</style>
</head>

<body>

<!-- Google auto loader -->
<div id="g_id_onload"
     data-client_id="687016135689-g9holcsj91ptukrlhr9a9bo23sroaun3.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
</div>

<!-- HEADER -->
<header id="header">
  <div id="logo">OLVIDEX</div>
  
  <div id="userSection">
    <!-- User Panel -->
    <div id="userPanel" class="hidden" onclick="toggleMenu()">
      <div id="userAvatar"></div>
      <span class="planBadge">Free</span>
      <svg class="icon icon-small" style="opacity: 0.7;">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </div>
    
    <!-- Sign In Button (when logged out) -->
    <div class="g_id_signin" data-type="icon" data-shape="circle" data-theme="outline" data-size="large"></div>
  </div>

  <!-- User Menu -->
  <div id="userMenu" class="hidden">
    <div class="menuItem" onclick="mejorarPlan()">
      <svg class="icon icon-small"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
      <span>Mejorar Plan</span>
    </div>
    <div class="menuItem" onclick="verRecordatorios()">
      <svg class="icon icon-small"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Mis Recordatorios</span>
    </div>
    <div class="menuDivider"></div>
    <div class="menuItem" onclick="logout()">
      <svg class="icon icon-small"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      <span>Cerrar sesiÃ³n</span>
    </div>
  </div>
</header>

<!-- MAIN CONTENT -->
<main id="mainContent">
  <!-- Result Panel -->
  <div id="resultPanel"></div>
  
  <!-- Transcribed Text -->
  <div id="transcribedContainer">
    <span id="transcribedText"></span>
  </div>
</main>

<!-- CENTER BUTTON (GO) -->
<div id="centerArea">
  <div id="aiCore">
    <div class="pulseRing"></div>
    <div class="pulseRing"></div>
    <div class="pulseRing"></div>
    <div id="coreText">GO</div>
  </div>
  <span id="hintText" class="hint-text">Toca y mantÃ©n para hablar</span>
</div>

<!-- Login Hint -->
<div id="loginHint" class="hidden">
  <svg class="icon" style="margin-bottom: 10px; opacity: 0.8;">
    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
  </svg>
  <div>Inicia sesiÃ³n con Google para usar Automatic Life</div>
</div>

<!-- BOTTOM BAR -->
<nav id="bottomBar">
  <div id="quickActions" class="hidden">
    <button class="quickBtn" onclick="setQuickText('Recordame maÃ±ana a las ')" title="Recordatorio maÃ±ana">
      <svg class="icon icon-small"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
      <span>MaÃ±ana</span>
    </button>
    <button class="quickBtn" onclick="setQuickText('Agendame ')" title="Agendar evento">
      <svg class="icon icon-small"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Agendar</span>
    </button>
    <button class="quickBtn" onclick="setQuickText('Pasame ')" title="Buscar informaciÃ³n">
      <svg class="icon icon-small"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <span>Buscar</span>
    </button>
  </div>
  
  <div style="flex: 1;"></div>
  
  <button id="notifBtn" class="hidden" onclick="solicitarNotificaciones()" title="Activar notificaciones">
    <svg class="icon"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
  </button>
  
  <div id="textFAB">
    <svg class="icon icon-large"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </div>
</nav>

<!-- TEXT MODAL -->
<div id="textModal" class="hidden">
  <div id="textBox">
    <div class="modalHeader">
      <span class="modalTitle" id="modalTitle">Escribe tu solicitud</span>
      <button id="closeModal" onclick="cerrarModal()">
        <svg class="icon"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <textarea id="textInput" placeholder="Ej: Recordame maÃ±ana a las 9:00 llamar al mÃ©dico"></textarea>
    <button id="sendTextBtn">
      <svg class="icon icon-small"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      <span id="sendBtnText">Enviar</span>
    </button>
  </div>
</div>

<script>
// ==================== VARIABLES GLOBALES ====================
let userEmail = null;
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingSeconds = 0;
let ultimoResultado = "";
let ultimoResultadoTexto = "";
let ultimoReminderData = null;
let modoEdicion = false;
let pushSubscription = null;
let pressTimer;
let isRecording = false;

// VAPID KEY CORRECTA - la de Knock
const VAPID_PUBLIC_KEY = 'BCEz3VvvDaXkZse_cMPmwS2s88ZTLiRshdRgLZZ7q2Fc5yCRkR9Y8nX1dmkw5tWvJhxABfLR7Ir8AsFF7CYJ7bw';

  // DETECCIÃ“N DE DISPOSITIVO
const ES_MOVIL = window.matchMedia('(pointer: coarse)').matches || window.innerWidth <= 768;
console.log('Â¿Es mÃ³vil?', ES_MOVIL);

// ==================== ELEMENTOS DOM ====================
const aiCore = document.getElementById("aiCore");
const coreText = document.getElementById("coreText");
const transcribedText = document.getElementById("transcribedText");
const resultPanel = document.getElementById("resultPanel");
const userPanel = document.getElementById("userPanel");
const userAvatar = document.getElementById("userAvatar");
const textFAB = document.getElementById("textFAB");
const textModal = document.getElementById("textModal");
const textInput = document.getElementById("textInput");
const sendTextBtn = document.getElementById("sendTextBtn");
const sendBtnText = document.getElementById("sendBtnText");
const modalTitle = document.getElementById("modalTitle");
const notifBtn = document.getElementById("notifBtn");
const quickActions = document.getElementById("quickActions");
const loginHint = document.getElementById("loginHint");
const userMenu = document.getElementById("userMenu");

// ==================== INICIALIZACIÃ“N ====================
document.addEventListener('DOMContentLoaded', () => {
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registrado:', reg))
      .catch(err => console.log('SW error:', err));
  }
  
  // Escuchar mensajes del SW
  navigator.serviceWorker?.addEventListener('message', event => {
    if (event.data.type === 'REMINDER_TRIGGERED') {
      mostrarResultado(`â° Recordatorio: ${event.data.message}`, false);
      speak(`Recordatorio: ${event.data.message}`);
    }
  });
  
  // Cerrar menÃº al hacer click fuera
  document.addEventListener('click', (e) => {
    if (!userPanel.contains(e.target) && !userMenu.contains(e.target)) {
      userMenu.classList.add('hidden');
    }
  });
  
  // ===== CONFIGURAR BOTÃ“N GO SEGÃšN DISPOSITIVO =====
  if (ES_MOVIL) {
    console.log('Configurando para MÃ“VIL');
    configurarBotonMovil();
  } else {
    console.log('Configurando para DESKTOP');
    configurarBotonDesktop();
  }

  // Inactivity timer (igual)
  let inactivityTimer;
  const INACTIVITY_DELAY = 10000;
  const HINT_DURATION = 10000;

  function showHint() {
    const hint = document.getElementById('hintText');
    if (!hint || !userEmail) return;
    hint.classList.add('visible');
    hint.classList.remove('fade-out');
    setTimeout(() => {
      hint.classList.add('fade-out');
      hint.classList.remove('visible');
    }, HINT_DURATION);
  }

  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(showHint, INACTIVITY_DELAY);
    const hint = document.getElementById('hintText');
    if (hint && hint.classList.contains('visible')) {
      hint.classList.add('fade-out');
      hint.classList.remove('visible');
    }
  }

  ['click', 'touchstart', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, resetInactivity, { passive: true });
  });

  resetInactivity();
});

// ==================== BOTÃ“N GO - MÃ“VIL ====================
function configurarBotonMovil() {
  // Remover cualquier listener anterior
  aiCore.replaceWith(aiCore.cloneNode(true));
  const nuevoAiCore = document.getElementById("aiCore");
  
  // Re-asignar variable global
  window.aiCore = nuevoAiCore;
  
  let touchIniciado = false;
  
  nuevoAiCore.addEventListener('touchstart', (e) => {
    e.preventDefault();
    console.log('MÃ“VIL: touchstart');
    
    if (!userEmail) {
      console.log('MÃ“VIL: Sin usuario, mostrando login');
      toggleMenu();
      loginHint.classList.remove('hidden');
      setTimeout(() => speak("Debes iniciar sesiÃ³n con Google para continuar."), 100);
      return;
    }
    
    touchIniciado = true;
    pressTimer = setTimeout(() => {
      if (touchIniciado) {
        isRecording = true;
        startRecording();
      }
    }, 200);
  }, {passive: false});

  nuevoAiCore.addEventListener('touchend', (e) => {
    e.preventDefault();
    console.log('MÃ“VIL: touchend');
    touchIniciado = false;
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });

  nuevoAiCore.addEventListener('touchcancel', (e) => {
    e.preventDefault();
    console.log('MÃ“VIL: touchcancel');
    touchIniciado = false;
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });
  
  // Prevenir completamente el click en mÃ³vil
  nuevoAiCore.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    console.log('MÃ“VIL: click bloqueado');
    return false;
  }, true);
}

// ==================== BOTÃ“N GO - DESKTOP ====================
function configurarBotonDesktop() {
  aiCore.addEventListener('mousedown', (e) => {
    console.log('DESKTOP: mousedown');
    if (!userEmail) {
      toggleMenu();
      loginHint.classList.remove('hidden');
      speak("Debes iniciar sesiÃ³n con Google para continuar.");
      return;
    }
    
    pressTimer = setTimeout(() => {
      isRecording = true;
      startRecording();
    }, 200);
  });

  aiCore.addEventListener('mouseup', () => {
    console.log('DESKTOP: mouseup');
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });

  aiCore.addEventListener('mouseleave', () => {
    console.log('DESKTOP: mouseleave');
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });
  
  // Click simple para desktop (alternativa al hold)
  aiCore.addEventListener('click', (e) => {
    console.log('DESKTOP: click');
    if (!userEmail) {
      toggleMenu();
      loginHint.classList.remove('hidden');
      speak("Debes iniciar sesiÃ³n con Google para continuar.");
      return;
    }
    
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      startRecording();
    } else {
      stopRecording();
    }
  });
}

// ==================== AUTENTICACIÃ“N ====================
function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = payload.email;

  userAvatar.textContent = payload.name
    ? payload.name.charAt(0).toUpperCase()
    : 'U';

  document.querySelector(".g_id_signin").classList.add("hidden");
  userPanel.classList.remove("hidden");
  userMenu.classList.add("hidden");
  loginHint.classList.add("hidden");
  notifBtn.classList.remove("hidden");
  quickActions.classList.remove("hidden");

  document.getElementById('centerArea').style.top = '73%';

  registrarPushSubscription();
}
  
async function registrarPushSubscription() {
  console.log("=== registrarPushSubscription INICIADO ===");
  console.log("userEmail recibido:", userEmail);

  if (!userEmail) return;
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();

    if (subscription) {
      console.log("ðŸ”” Push EXISTE en navegador â†’ prender campanita");
      pushSubscription = subscription;
      notifBtn.classList.add("granted");
      notifBtn.innerHTML = '<svg class="icon"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      console.log("=== registrarPushSubscription FIN ===");
      return;
    }

    console.log("ðŸ”• No hay push en navegador â†’ campanita apagada");
    pushSubscription = null;
    notifBtn.classList.remove("granted");
    notifBtn.innerHTML = '<svg class="icon"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>';
    console.log("=== registrarPushSubscription FIN ===");

  } catch (err) {
    console.error("ðŸ’¥ ERROR:", err);
  }
}

function toggleMenu() {
  userMenu.classList.toggle("hidden");
}

function logout() {
  userEmail = null;
  userAvatar.textContent = "";
  userPanel.classList.add("hidden");
  document.querySelector(".g_id_signin").classList.remove("hidden");
  userMenu.classList.add("hidden");
  notifBtn.classList.add("hidden");
  quickActions.classList.add("hidden");

  transcribedText.textContent = "";
  resultPanel.innerHTML = "";
  resultPanel.classList.remove("show");
  loginHint.classList.remove("hidden");
  
  document.getElementById('centerArea').style.top = '50%';

  stopCoreAnimation();
  coreText.textContent = "GO";
  
  pushSubscription = null;
  
  if (window.google && window.google.accounts) {
    window.google.accounts.id.disableAutoSelect();
  }
}

function mejorarPlan() {
  userMenu.classList.add("hidden");
  mostrarResultado("FunciÃ³n disponible prÃ³ximamente. Â¡Gracias por tu interÃ©s!", false);
}

async function verRecordatorios() {
  userMenu.classList.add("hidden");
  if (!userEmail) return;
  
  startCoreAnimation("...");
  
  try {
    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: "listar recordatorios",
        email: userEmail
      })
    });
    
    const data = await res.json();
    if (data.result) {
      mostrarResultado(data.result, false);
    }
  } catch (err) {
    mostrarResultado("Error al cargar recordatorios", false);
  }
  
  stopCoreAnimation();
}

// ==================== NOTIFICACIONES PUSH ====================
async function solicitarNotificaciones() {
  if (!userEmail) {
    speak("Debes iniciar sesiÃ³n primero");
    return;
  }

  try {
    const registration = await navigator.serviceWorker.ready;
    let subscription = await registration.pushManager.getSubscription();

    // Si NO hay suscripciÃ³n â†’ pedir permiso y crearla
    if (!subscription) {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        mostrarResultado("Necesitas permitir notificaciones", false);
        return;
      }

      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
    }

    // SIEMPRE guardar en backend
    pushSubscription = subscription;

    await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "registerPush",
        email: userEmail,
        subscription: subscription
      })
    });

    notifBtn.classList.add("granted");
    notifBtn.innerHTML = '<svg class="icon"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    mostrarResultado("Notificaciones activadas correctamente ðŸ””", false);
    
  } catch (err) {
    console.error("Error activando notificaciones:", err);
    mostrarResultado("Error al activar notificaciones", false);
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

// ==================== VOZ ====================
function speak(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "es-AR";
  utterance.rate = 1;
  utterance.pitch = 1;
  startCoreAnimation("AI");
  utterance.onend = () => stopCoreAnimation();
  speechSynthesis.speak(utterance);
}

// ==================== ANIMACIONES ====================
function startCoreAnimation(label) {
  aiCore.classList.add("ai-active");
  
  if (label === "REC") {
    recordingSeconds = 0;
    coreText.innerHTML = `<span style="font-size:0.9rem">REC</span><br><span style="font-size:0.7rem">0s</span>`;
    recordingTimer = setInterval(() => {
      recordingSeconds++;
      coreText.innerHTML = `<span style="font-size:0.9rem">REC</span><br><span style="font-size:0.7rem">${recordingSeconds}s</span>`;
      
      if (recordingSeconds >= 30) {
        stopRecording();
      }
    }, 1000);
  } else if (label === "...") {
    coreText.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
  } else {
    coreText.textContent = label;
  }
}

function stopCoreAnimation() {
  aiCore.classList.remove("ai-active");
  clearInterval(recordingTimer);
  coreText.textContent = "GO";
}

// ==================== UI RESULTADOS ====================
function mostrarResultado(texto, mostrarEditar = false, esRecordatorio = false, reminderData = null, datosExtra = null) {
  ultimoResultado = texto;
  ultimoResultadoTexto = texto.replace(/<[^>]*>/g, '').trim();
  
  if (reminderData && reminderData.isReminder) {
    ultimoReminderData = reminderData;
    console.log("âœ“ Guardado reminderData (desde creaciÃ³n):", ultimoReminderData);
  } else if (datosExtra && datosExtra.reminderId) {
    ultimoReminderData = {
      isReminder: true,
      id: datosExtra.reminderId,
      type: datosExtra.tipo || 'unico',
      dateText: datosExtra.dateText || '',
      timeText: datosExtra.timeText || '09:00',
      description: datosExtra.description || ultimoResultadoTexto
    };
    console.log("âœ“ Guardado reminderData (desde bÃºsqueda):", ultimoReminderData);
  } else if (!modoEdicion) {
    ultimoReminderData = null;
  }
  
  let html = `<div class="result-content">${texto}</div>`;
  
  if (esRecordatorio || (datosExtra && datosExtra.reminderId)) {
    html += `<div class="reminder-badge"><svg class="icon icon-small" style="stroke: currentColor;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Recordatorio programado</div>`;
  }
  
  if (mostrarEditar || (datosExtra && datosExtra.reminderId)) {
    html += `<button class="edit-btn" onclick="activarEdicion()"><svg class="icon icon-small" style="stroke: currentColor;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Editar</button>`;
  }
  
  resultPanel.innerHTML = html;
  resultPanel.classList.add("show");
  
  if (window.innerWidth <= 768) {
    resultPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function activarEdicion() {
  console.log("=== ACTIVAR EDICIÃ“N ===");
  console.log("ultimoResultadoTexto:", ultimoResultadoTexto);
  console.log("ultimoReminderData:", ultimoReminderData);
  
  if (!ultimoResultadoTexto) {
    console.error("No hay texto para editar");
    return;
  }
  
  modoEdicion = true;
  
  if (ultimoReminderData && ultimoReminderData.isReminder) {
    const tipo = ultimoReminderData.type || 'unico';
    const fecha = ultimoReminderData.dateText || 'maÃ±ana';
    const hora = ultimoReminderData.timeText || '09:00';
    const descripcion = ultimoReminderData.description || ultimoResultadoTexto;
    
    const horaBonita = hora.replace(/:00$/, 'hs').replace(/:(\d+)$/, ':$1');
    
    textInput.value = `Recordame ${fecha} a las ${horaBonita} ${descripcion}`;
    modalTitle.textContent = "Editar recordatorio";
    sendBtnText.textContent = "Guardar cambios";
    
    console.log("Texto reconstruido para ediciÃ³n:", textInput.value);
    console.log("ID del recordatorio a editar:", ultimoReminderData.id);
  } else {
    textInput.value = ultimoResultadoTexto;
    modalTitle.textContent = "Editar nota";
    sendBtnText.textContent = "Guardar cambios";
    console.log("EdiciÃ³n normal (sin ID de recordatorio):", textInput.value);
  }
  
  textModal.classList.remove("hidden");
  textInput.focus();
  textInput.select();
}

function setQuickText(texto) {
  if (!userEmail) {
    toggleMenu();
    return;
  }
  modoEdicion = false;
  textInput.value = texto;
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
  textModal.classList.remove("hidden");
  textInput.focus();
}

// ==================== MODAL TEXTO ====================
textFAB.onclick = () => {
  if (!userEmail) {
    toggleMenu();
    loginHint.classList.remove("hidden");
    speak("Debes iniciar sesiÃ³n con Google para continuar.");
    return;
  }

  modoEdicion = false;
  ultimoReminderData = null;
  textInput.value = "";
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
  textModal.classList.remove("hidden");
  textInput.focus();
};

textModal.onclick = (e) => {
  if (e.target === textModal) {
    cerrarModal();
  }
};

textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    cerrarModal();
  }
  if (e.key === 'Enter' && e.ctrlKey) {
    sendTextBtn.click();
  }
});

function cerrarModal() {
  textModal.classList.add("hidden");
  modoEdicion = false;
  textInput.value = "";
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
}

// ==================== ENVIAR TEXTO ====================
sendTextBtn.onclick = async () => {
  const texto = textInput.value.trim();
  if (!texto) return;

  const esEdicion = modoEdicion;
  const reminderActual = ultimoReminderData;

  console.log("=== ENVIAR TEXTO ===");
  console.log("esEdicion:", esEdicion);
  console.log("texto:", texto);

  cerrarModal();
  
  transcribedText.textContent = esEdicion ? `Editando: ${texto}` : texto;

  try {
    startCoreAnimation("...");

    if (esEdicion && reminderActual && reminderActual.id) {
      console.log("=== EDICIÃ“N: Borrando viejo ===");
      
      await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "delete",
          text: reminderActual.description,
          email: userEmail,
          userId: userEmail
        })
      });
      
      const res = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: texto,
          email: userEmail,
          userId: userEmail
        })
      });
      
      const data = await res.json();
      if (data.ok) {
        mostrarResultado(data.result, false, true, data.reminderData);
        ultimoReminderData = data.reminderData;
      }
      
      if (data.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${data.audioBase64}`);
        startCoreAnimation("AI");
        audio.play();
        audio.onended = () => stopCoreAnimation();
      } else {
        stopCoreAnimation();
      }
      
      return;
    }

    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: texto,
        email: userEmail,
        userId: userEmail
      })
    });

    const data = await res.json();
    modoEdicion = false;

    if (data.result) {
      const esBusqueda = data.action === "get" && !data.result.toLowerCase().includes("no encontr");
      const esRecordatorio = data.reminderData && data.reminderData.isReminder;
      
      const datosExtra = data.reminderId ? {
        reminderId: data.reminderId,
        tipo: data.tipo,
        dateText: data.dateText,
        timeText: data.timeText,
        description: data.description
      } : null;
      
      mostrarResultado(data.result, esBusqueda, esRecordatorio, data.reminderData, datosExtra);
    }

    if (data.ok && data.audioBase64) {
      const audio = new Audio(`data:audio/mpeg;base64,${data.audioBase64}`);
      startCoreAnimation("AI");
      audio.play();
      audio.onended = () => stopCoreAnimation();
    } else {
      stopCoreAnimation();
    }

  } catch (err) {
    console.error("Error:", err);
    mostrarResultado("Error de conexiÃ³n. Intenta de nuevo.", false);
    stopCoreAnimation();
    modoEdicion = false;
  }
};

// ==================== GRABACIÃ“N DE VOZ ====================
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });
    
    const options = { mimeType: 'audio/webm;codecs=opus' };
    mediaRecorder = new MediaRecorder(stream, options);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };
    
    mediaRecorder.onstop = sendAudio;
    mediaRecorder.start(100);
    
    startCoreAnimation("REC");
  } catch(err) {
    console.error(err);
    mostrarResultado("Error al acceder al micrÃ³fono. Verifica los permisos.", false);
    speak("No puedo acceder al micrÃ³fono");
    isRecording = false;
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
    stopCoreAnimation();
  }
}

async function sendAudio() {
  if (audioChunks.length === 0) return;
  
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const reader = new FileReader();
  reader.readAsDataURL(blob);

  reader.onloadend = async () => {
    const base64 = reader.result.split(",")[1];

    try {
      startCoreAnimation("...");

      const resTrans = await fetch("/.netlify/functions/transcribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ audio: base64 })
      });

      const dataTrans = await resTrans.json();
      
      if (!dataTrans.text) {
        throw new Error("No se pudo transcribir el audio");
      }
      
      const texto = dataTrans.text;
      transcribedText.textContent = texto;

      const resResp = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: texto,
          email: userEmail
        })
      });

      const dataResp = await resResp.json();

      if (dataResp.result) {
        const esBusqueda = dataResp.action === "get" && !dataResp.result.toLowerCase().includes("no encontr");
        const esRecordatorio = dataResp.reminderData && dataResp.reminderData.isReminder;
        
        const datosExtra = dataResp.reminderId ? {
          reminderId: dataResp.reminderId,
          tipo: dataResp.tipo,
          dateText: dataResp.dateText,
          timeText: dataResp.timeText,
          description: dataResp.description
        } : null;
        
        mostrarResultado(dataResp.result, esBusqueda, esRecordatorio, dataResp.reminderData, datosExtra);
      }

      if (dataResp.ok && dataResp.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${dataResp.audioBase64}`);
        startCoreAnimation("AI");
        audio.play();
        audio.onended = () => stopCoreAnimation();
      } else {
        stopCoreAnimation();
      }

    } catch (err) {
      console.error(err);
      transcribedText.textContent = "[Error de procesamiento]";
      mostrarResultado("No pude procesar tu solicitud. Intenta de nuevo.", false);
      stopCoreAnimation();
    }
  };
  
  reader.onerror = () => {
    transcribedText.textContent = "[Error de lectura]";
    stopCoreAnimation();
  };
}


</script>
</body>
</html>
