<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Olvidex</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
/* ===== CSS ORIGINAL COMPLETO ===== */
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
  --primary: #00ffea; --primary-dark: #00c4b4; --bg-dark: #0f0c29;
  --bg-mid: #302b63; --bg-light: #24243e; --danger: #ff6b6b;
  --warning: #ffc107; --glass: rgba(0, 255, 234, 0.05); --glass-border: rgba(0, 255, 234, 0.2);
}
body {
  margin: 0; min-height: 100vh; min-height: 100dvh; display: flex; flex-direction: column;
  background: linear-gradient(135deg, var(--bg-dark), var(--bg-mid), var(--bg-light));
  font-family: 'Segoe UI', system-ui, sans-serif; color: var(--primary);
  overflow-x: hidden; position: relative;
}
.icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
#header { position: fixed; top: 0; left: 0; right: 0; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; background: linear-gradient(to bottom, rgba(15, 12, 41, 0.9), transparent); }
#logo { font-size: 1.3rem; font-weight: bold; letter-spacing: 2px; background: linear-gradient(to right, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
#userSection { display: flex; align-items: center; gap: 10px; }
#userPanel { cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 25px; transition: all 0.3s; font-size: 0.85rem; }
#userPanel:hover { background: rgba(0, 255, 234, 0.1); border-color: var(--primary); }
#userAvatar { width: 28px; height: 28px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: var(--bg-dark); font-weight: bold; font-size: 0.8rem; }
.planBadge { background: rgba(0, 255, 234, 0.15); padding: 3px 8px; border-radius: 10px; border: 1px solid var(--primary); font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
#userMenu { position: absolute; top: 60px; right: 20px; background: rgba(15, 12, 41, 0.98); border: 1px solid var(--primary); border-radius: 16px; padding: 12px; min-width: 220px; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8); z-index: 200; transform-origin: top right; display: none; }
#userMenu.visible { display: block; animation: menuAppear 0.2s ease; }
@keyframes menuAppear { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.menuItem { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-size: 0.9rem; }
.menuItem:hover { background: rgba(0, 255, 234, 0.1); }
.menuItem:last-child { margin-bottom: 0; color: var(--danger); }
.menuItem:last-child:hover { background: rgba(255, 107, 107, 0.1); }
.menuDivider { height: 1px; background: var(--glass-border); margin: 8px 0; }
#mainContent { flex: 1; display: flex; flex-direction: column; padding: 80px 20px 140px; max-width: 800px; margin: 0 auto; width: 100%; position: relative; }
#resultPanel { flex: 1; min-height: 200px; max-height: calc(80vh - 300px); border: 1px solid var(--glass-border); border-radius: 20px; background: var(--glass); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; opacity: 0; transform: translateY(20px); transition: all 0.4s ease; display: flex; flex-direction: column; gap: 15px; }
#resultPanel.show { opacity: 1; transform: translateY(0); }
#resultPanel::-webkit-scrollbar { width: 6px; }
#resultPanel::-webkit-scrollbar-track { background: rgba(0, 255, 234, 0.05); border-radius: 3px; }
#resultPanel::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
.result-content { line-height: 1.6; font-size: 1rem; }
#transcribedContainer { text-align: center; padding: 15px; opacity: 0.7; font-style: italic; font-size: 0.9rem; min-height: 50px; display: flex; align-items: center; justify-content: center; }
#centerArea { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; display: flex; flex-direction: column; align-items: center; gap: 20px; pointer-events: none; }
#centerArea.logged { top: 73%; }
#aiCore { position: relative; width: 140px; height: 140px; border-radius: 50%; background: radial-gradient(circle, var(--primary) 0%, var(--primary-dark) 70%, #003a38 100%); display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 40px rgba(0, 255, 234, 0.6), 0 0 80px rgba(0, 255, 234, 0.3), inset 0 0 30px rgba(255, 255, 255, 0.3); transition: all 0.3s ease; user-select: none; pointer-events: all; }
#aiCore:hover { transform: scale(1.08); box-shadow: 0 0 60px rgba(0, 255, 234, 0.8), 0 0 100px rgba(0, 255, 234, 0.4); }
#aiCore:active { transform: scale(0.95); }
#coreText { color: var(--bg-dark); font-weight: bold; font-size: 1.3rem; letter-spacing: 3px; pointer-events: none; }
.pulseRing { position: absolute; width: 100%; height: 100%; border: 2px solid var(--primary); border-radius: 50%; opacity: 0; pointer-events: none; }
.ai-active .pulseRing { animation: pulseWave 1.5s infinite; }
.pulseRing:nth-child(1) { animation-delay: 0s; }
.pulseRing:nth-child(2) { animation-delay: 0.5s; }
.pulseRing:nth-child(3) { animation-delay: 1s; }
@keyframes pulseWave { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.2); opacity: 0; } }
#bottomBar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 12, 41, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); padding: 15px 20px; display: flex; align-items: center; gap: 15px; z-index: 100; }
#quickActions { display: flex; gap: 8px; }
.quickBtn { background: var(--glass); border: 1px solid var(--glass-border); color: var(--primary); padding: 10px 14px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
.quickBtn:hover { background: rgba(0, 255, 234, 0.15); border-color: var(--primary); transform: translateY(-2px); }
#textFAB { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: var(--bg-dark); display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(0, 255, 234, 0.5); transition: all 0.3s; flex-shrink: 0; }
#textFAB:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 30px rgba(0, 255, 234, 0.7); }
#notifBtn { width: 45px; height: 45px; border-radius: 50%; background: var(--glass); border: 2px solid var(--glass-border); color: var(--primary); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; flex-shrink: 0; }
#notifBtn:hover { background: rgba(0, 255, 234, 0.15); transform: scale(1.1); }
#notifBtn.granted { background: var(--primary); color: var(--bg-dark); border-color: var(--primary); }
#textModal { position: fixed; inset: 0; background: rgba(5, 10, 25, 0.9); backdrop-filter: blur(20px); justify-content: center; align-items: flex-end; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px; display: none; }
#textModal.visible { display: flex; opacity: 1; pointer-events: all; }
#textBox { background: rgba(15, 12, 41, 0.98); border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 -10px 60px rgba(0, 0, 0, 0.8); transform: translateY(20px); transition: transform 0.3s; margin-bottom: env(safe-area-inset-bottom, 0); }
#textModal.visible #textBox { transform: translateY(0); }
.modalHeader { display: flex; justify-content: space-between; align-items: center; }
.modalTitle { font-size: 1.1rem; font-weight: 600; }
#closeModal { background: none; border: none; color: var(--primary); cursor: pointer; padding: 5px; border-radius: 50%; transition: background 0.2s; }
#closeModal:hover { background: rgba(0, 255, 234, 0.1); }
#textInput { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; color: var(--primary); font-size: 16px; resize: none; outline: none; height: 120px; font-family: inherit; transition: all 0.3s; line-height: 1.5; }
#textInput::placeholder { color: rgba(0, 255, 234, 0.4); }
#textInput:focus { border-color: var(--primary); box-shadow: 0 0 20px rgba(0, 255, 234, 0.2); background: rgba(0, 0, 0, 0.5); }
#sendTextBtn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; border-radius: 12px; padding: 16px; font-weight: bold; letter-spacing: 1px; color: var(--bg-dark); cursor: pointer; box-shadow: 0 4px 20px rgba(0, 255, 234, 0.4); transition: all 0.3s; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
#sendTextBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(0, 255, 234, 0.6); }
#sendTextBtn:active { transform: translateY(0); }
.loading-dots { display: inline-flex; gap: 4px; }
.loading-dots span { animation: bounce 1.4s infinite ease-in-out both; background: var(--bg-dark); border-radius: 50%; width: 8px; height: 8px; }
.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
.reminder-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255, 193, 7, 0.15); border: 1px solid var(--warning); color: var(--warning); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; width: fit-content; }
.hidden { display: none !important; }
#loginHint { position: fixed; top: 75%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 20px 10px; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 16px; color: var(--danger); font-size: 0.75rem; max-width: 300px; z-index: 40; }
@media (max-width: 768px) {
  #header { padding: 12px 15px; }
  #logo { font-size: 1.1rem; }
  #mainContent { padding: 70px 15px 160px; }
  #resultPanel { min-height: 150px; max-height: calc(80vh - 280px); padding: 15px; border-radius: 16px; }
  #aiCore { width: 90px; height: 90px; }
  #coreText { font-size: 1.1rem; }
  #bottomBar { padding: 12px 15px; gap: 10px; }
  .quickBtn { padding: 8px 12px; font-size: 0.75rem; }
  .quickBtn span { display: none; }
  #textFAB { width: 45px; height: 45px; }
  #notifBtn { width: 40px; height: 40px; }
  #userMenu { right: 15px; min-width: 200px; }
}
</style>
</head>
<body>

<div id="g_id_onload" data-client_id="687016135689-g9holcsj91ptukrlhr9a9bo23sroaun3.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>

<header id="header">
  <div id="logo">OLVIDEX</div>
  <div id="userSection">
    <div id="userPanel" class="hidden" onclick="toggleMenu()">
      <div id="userAvatar"></div>
      <span class="planBadge">Free</span>
      <svg class="icon" style="opacity: 0.7;"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </div>
    <div class="g_id_signin" data-type="icon" data-shape="circle" data-theme="outline" data-size="large"></div>
  </div>
  <div id="userMenu">
    <div class="menuItem" onclick="verRecordatorios()">
      <svg class="icon"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
      <span>Mis Recordatorios</span>
    </div>
    <div class="menuItem" onclick="verAgenda()">
      <svg class="icon"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Mi Agenda</span>
    </div>
    <div class="menuDivider"></div>
    <div class="menuItem" onclick="logout()">
      <svg class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      <span>Cerrar sesi√≥n</span>
    </div>
  </div>
</header>

<main id="mainContent">
  <div id="resultPanel"></div>
  <div id="transcribedContainer"><span id="transcribedText"></span></div>
</main>

<div id="centerArea">
  <div id="aiCore">
    <div class="pulseRing"></div>
    <div class="pulseRing"></div>
    <div class="pulseRing"></div>
    <div id="coreText">GO</div>
  </div>
</div>

<div id="loginHint" class="hidden">
  <svg class="icon" style="margin-bottom: 10px; opacity: 0.8;"><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
  <div>Inicia sesi√≥n con Google para usar Olvidex</div>
</div>

<nav id="bottomBar">
  <div id="quickActions" class="hidden">
    <button class="quickBtn" onclick="setQuickText('Agendame ')" title="Agendar">
      <svg class="icon"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Agendar</span>
    </button>
    <button class="quickBtn" onclick="setQuickText('Recordame ')" title="Recordatorio">
      <svg class="icon"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
      <span>Recordar</span>
    </button>
    <button class="quickBtn" onclick="setQuickText('Pasame ')" title="Buscar">
      <svg class="icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <span>Buscar</span>
    </button>
  </div>
  <div style="flex: 1;"></div>
  <button id="notifBtn" class="hidden" onclick="solicitarNotificaciones()">
    <svg class="icon"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
  </button>
  <div id="textFAB" onclick="abrirModal()">
    <svg class="icon"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </div>
</nav>

<div id="textModal">
  <div id="textBox">
    <div class="modalHeader">
      <span class="modalTitle">Escribe tu solicitud</span>
      <button id="closeModal" onclick="cerrarModal()">
        <svg class="icon"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <textarea id="textInput" placeholder="Ej: Recordame ma√±ana a las 9 llamar al m√©dico"></textarea>
    <button id="sendTextBtn" onclick="enviarTexto()">
      <svg class="icon"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      <span>Enviar</span>
    </button>
  </div>
</div>

<script>
// ===== CONFIG =====
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKXRHZXrdu9r149OcUdjTh16pX46mmJ_je1ozJ3pACA3_oloct7go2ynDbaVrnkmLe/exec';
const VAPID_PUBLIC_KEY = 'BLQULctrbctZlLNCLlDsVWmrCKtUF6iCPB6VRVVergi9Lj8hdw1oHHArs8OEdqfbW6u_vmWF99tvQjuphPjHLeg';

let userEmail = null;
let recognition = null;
let isRecording = false;

// ===== DOM =====
const aiCore = document.getElementById('aiCore');
const coreText = document.getElementById('coreText');
const resultPanel = document.getElementById('resultPanel');
const transcribedText = document.getElementById('transcribedText');
const userPanel = document.getElementById('userPanel');
const userAvatar = document.getElementById('userAvatar');
const textModal = document.getElementById('textModal');
const textInput = document.getElementById('textInput');
const centerArea = document.getElementById('centerArea');

// ===== INICIO =====
document.addEventListener('DOMContentLoaded', () => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
  }
  
  // Web Speech API
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'es-AR';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = (e) => {
      const texto = e.results[0][0].transcript;
      transcribedText.textContent = texto;
      procesarComando(texto);
    };
    
    recognition.onerror = () => {
      stopCoreAnimation();
      mostrarResultado('Error al escuchar. Intenta de nuevo.');
    };
    
    recognition.onend = () => {
      if (isRecording) stopCoreAnimation();
      isRecording = false;
    };
  }
  
  setupGestos();
});

function setupGestos() {
  let pressTimer;
  
  const startPress = (e) => {
    e.preventDefault();
    if (!userEmail) return mostrarLoginHint();
    pressTimer = setTimeout(() => {
      isRecording = true;
      startRecording();
    }, 300);
  };
  
  const endPress = () => {
    clearTimeout(pressTimer);
    if (isRecording) stopRecording();
  };
  
  aiCore.addEventListener('touchstart', startPress, {passive: false});
  aiCore.addEventListener('touchend', endPress);
  aiCore.addEventListener('mousedown', startPress);
  aiCore.addEventListener('mouseup', endPress);
  aiCore.addEventListener('mouseleave', endPress);
}

// ===== AUTH =====
function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = payload.email;
  userAvatar.textContent = (payload.name || 'U').charAt(0).toUpperCase();
  
  document.querySelector('.g_id_signin').classList.add('hidden');
  userPanel.classList.remove('hidden');
  document.getElementById('quickActions').classList.remove('hidden');
  document.getElementById('notifBtn').classList.remove('hidden');
  document.getElementById('loginHint').classList.add('hidden');
  centerArea.classList.add('logged');
  
  checkNotificaciones();
}

function toggleMenu() {
  document.getElementById('userMenu').classList.toggle('visible');
}

function logout() {
  userEmail = null;
  userPanel.classList.add('hidden');
  document.querySelector('.g_id_signin').classList.remove('hidden');
  document.getElementById('userMenu').classList.remove('visible');
  document.getElementById('quickActions').classList.add('hidden');
  document.getElementById('notifBtn').classList.add('hidden');
  centerArea.classList.remove('logged');
  resultPanel.classList.remove('show');
  transcribedText.textContent = '';
  if (window.google) google.accounts.id.disableAutoSelect();
}

function mostrarLoginHint() {
  const hint = document.getElementById('loginHint');
  hint.classList.remove('hidden');
  setTimeout(() => hint.classList.add('hidden'), 3000);
  hablar('Debes iniciar sesi√≥n para continuar');
}

// ===== GRABACI√ìN =====
function startRecording() {
  if (!recognition) {
    mostrarResultado('Tu navegador no soporta reconocimiento de voz');
    return;
  }
  startCoreAnimation('REC');
  recognition.start();
}

function stopRecording() {
  if (recognition) recognition.stop();
  stopCoreAnimation();
}

// ===== UI =====
function startCoreAnimation(label) {
  aiCore.classList.add('ai-active');
  if (label === 'REC') {
    coreText.innerHTML = '<span style="font-size:0.8rem">ESCUCHANDO</span>';
  } else if (label === '...') {
    coreText.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
  } else {
    coreText.textContent = label;
  }
}

function stopCoreAnimation() {
  aiCore.classList.remove('ai-active');
  coreText.textContent = 'GO';
}

function mostrarResultado(html, esRecordatorio = false) {
  let content = `<div class="result-content">${html}</div>`;
  if (esRecordatorio) {
    content += `<div class="reminder-badge"><svg class="icon" style="stroke:currentColor;width:16px;height:16px"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Recordatorio activado</div>`;
  }
  resultPanel.innerHTML = content;
  resultPanel.classList.add('show');
}

function hablar(texto) {
  const u = new SpeechSynthesisUtterance(texto);
  u.lang = 'es-AR';
  u.rate = 1;
  speechSynthesis.speak(u);
}

// ===== COMUNICACI√ìN CON APPS SCRIPT =====
async function procesarComando(texto) {
  if (!userEmail) return;
  
  startCoreAnimation('...');
  
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'procesar',
        userId: userEmail,
        texto: texto
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      mostrarResultado(data.resultado, data.esRecordatorio);
      if (data.mensajeVoz) hablar(data.mensajeVoz);
    } else {
      mostrarResultado(data.error || 'Error al procesar');
    }
    
  } catch (err) {
    console.error(err);
    mostrarResultado('Error de conexi√≥n');
  }
  
  stopCoreAnimation();
}

// ===== MODAL =====
function abrirModal() {
  if (!userEmail) return mostrarLoginHint();
  textModal.classList.add('visible');
  textInput.value = '';
  textInput.focus();
}

function cerrarModal() {
  textModal.classList.remove('visible');
}

function setQuickText(texto) {
  abrirModal();
  textInput.value = texto;
  textInput.focus();
}

async function enviarTexto() {
  const texto = textInput.value.trim();
  if (!texto) return;
  cerrarModal();
  transcribedText.textContent = texto;
  await procesarComando(texto);
}

textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    enviarTexto();
  }
  if (e.key === 'Escape') cerrarModal();
});

// ===== PUSH NOTIFICATIONS =====
async function checkNotificaciones() {
  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.getSubscription();
  if (subscription) {
    document.getElementById('notifBtn').classList.add('granted');
  }
}

async function solicitarNotificaciones() {
  if (!userEmail) return;
  
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    mostrarResultado('Necesitas permitir notificaciones');
    return;
  }
  
  try {
    const registration = await navigator.serviceWorker.ready;
    
    // DESUSCRIBIR PRIMERO SI EXISTE
    const existingSubscription = await registration.pushManager.getSubscription();
    if (existingSubscription) {
      await existingSubscription.unsubscribe();
      console.log('Suscripci√≥n anterior eliminada');
    }
    
    // CREAR NUEVA SUSCRIPCI√ìN
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'guardarPush',
        userId: userEmail,
        subscription: JSON.stringify(subscription)
      })
    });
    
    document.getElementById('notifBtn').classList.add('granted');
    mostrarResultado('Notificaciones activadas üî•');
    
  } catch (err) {
    console.error(err);
    mostrarResultado('Error al activar notificaciones');
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

// ===== MEN√ö =====
async function verRecordatorios() {
  toggleMenu();
  if (!userEmail) return;
  
  startCoreAnimation('...');
  
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'listarRecordatorios',
        userId: userEmail
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.recordatorios.length > 0) {
      let html = '<strong>üìÖ Tus recordatorios:</strong><br><br>';
      data.recordatorios.forEach(r => {
        html += `‚Ä¢ ${r.texto} - ${r.fecha} ${r.hora}<br>`;
      });
      mostrarResultado(html, true);
    } else {
      mostrarResultado('No tienes recordatorios activos');
    }
    
  } catch (err) {
    mostrarResultado('Error al cargar');
  }
  
  stopCoreAnimation();
}

async function verAgenda() {
  toggleMenu();
  if (!userEmail) return;
  
  startCoreAnimation('...');
  
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'listarAgenda',
        userId: userEmail
      })
    });
    
    const data = await res.json();
    
    if (data.ok && data.items.length > 0) {
      let html = '<strong>üìù Tu agenda:</strong><br><br>';
      data.items.forEach(item => {
        const fecha = item.fecha ? `(${item.fecha})` : '';
        html += `‚Ä¢ ${item.texto} ${fecha}<br>`;
      });
      mostrarResultado(html);
    } else {
      mostrarResultado('Tu agenda est√° vac√≠a');
    }
    
  } catch (err) {
    mostrarResultado('Error al cargar');
  }
  
  stopCoreAnimation();
}

// Cerrar men√∫ al hacer click fuera
document.addEventListener('click', (e) => {
  const menu = document.getElementById('userMenu');
  if (!userPanel.contains(e.target) && !menu.contains(e.target)) {
    menu.classList.remove('visible');
  }
});
</script>
</body>
</html>
