<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiliX</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* Estilos base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffc107;
    }
    
    /* User panel */
    .user-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      transition: background 0.3s;
    }
    
    .user-panel:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #ffc107;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #1a1a2e;
    }
    
    .user-menu {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #fff;
      color: #333;
      border-radius: 12px;
      padding: 10px 0;
      min-width: 200px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 200;
    }
    
    .user-menu.hidden {
      display: none;
    }
    
    .user-menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .user-menu-item:hover {
      background: #f5f5f5;
    }
    
    /* Main area */
    .main-area {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 90%;
      max-width: 500px;
      transition: top 0.3s ease;
    }
    
    .main-area.authenticated {
      top: 73%;
    }
    
    /* AI Core */
    .ai-core {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0 auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .ai-core:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6);
    }
    
    .ai-core.ai-active {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .core-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff;
    }
    
    /* Loading dots */
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #fff;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Transcribed text */
    .transcribed-text {
      min-height: 30px;
      color: #ffc107;
      font-size: 1.1rem;
      margin-bottom: 20px;
      padding: 0 20px;
    }
    
    /* Result panel */
    .result-panel {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      width: 90%;
      max-width: 500px;
      max-height: 50vh;
      overflow-y: auto;
      background: #fff;
      color: #333;
      border-radius: 16px;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 50;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .result-panel.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    
    .result-content {
      line-height: 1.6;
    }
    
    .reminder-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #fff8e1;
      color: #ffc107;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    
    .edit-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 15px;
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .edit-btn:hover {
      background: #45a049;
    }
    
    /* Resultados lista */
    .resultados-lista {
      max-height: 40vh;
      overflow-y: auto;
    }
    
    .resultados-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      color: #667eea;
    }
    
    .resultado-item {
      transition: transform 0.2s;
    }
    
    .resultado-item:hover {
      transform: translateX(5px);
    }
    
    /* Quick actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .quick-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .quick-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* Text FAB */
    .text-fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ffc107;
      color: #1a1a2e;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
      transition: all 0.3s;
      z-index: 60;
    }
    
    .text-fab:hover {
      transform: scale(1.1);
    }
    
    /* Text modal */
    .text-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .text-modal:not(.hidden) {
      opacity: 1;
      visibility: visible;
    }
    
    .text-modal.hidden {
      display: none;
    }
    
    .modal-content {
      background: #fff;
      color: #333;
      border-radius: 16px;
      padding: 25px;
      width: 90%;
      max-width: 450px;
    }
    
    .modal-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #667eea;
    }
    
    .text-input {
      width: 100%;
      min-height: 100px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      resize: vertical;
      font-family: inherit;
    }
    
    .text-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .modal-btn-primary {
      background: #667eea;
      color: white;
    }
    
    .modal-btn-primary:hover {
      background: #5a67d8;
    }
    
    .modal-btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    /* Notif button */
    .notif-btn {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 60;
    }
    
    .notif-btn.granted {
      background: #4CAF50;
      border-color: #4CAF50;
    }
    
    .notif-btn:hover {
      transform: scale(1.1);
    }
    
    /* Icons */
    .icon {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .icon-small {
      width: 16px;
      height: 16px;
    }
    
    /* Login hint */
    .login-hint {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffc107;
      color: #1a1a2e;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 0.9rem;
      z-index: 150;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .login-hint.hidden {
      display: none;
    }
    
    /* Google sign in */
    .g_id_signin {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Hint text */
    .hint-text {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
    }
    
    .hint-text.visible {
      opacity: 1;
    }
    
    .hint-text.fade-out {
      opacity: 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .main-area {
        width: 95%;
      }
      
      .ai-core {
        width: 100px;
        height: 100px;
      }
      
      .core-text {
        font-size: 1.2rem;
      }
      
      .result-panel {
        width: 95%;
        max-height: 60vh;
        bottom: 80px;
      }
      
      .text-fab {
        bottom: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
      }
      
      .notif-btn {
        bottom: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="logo">LiliX</div>
    <div class="user-panel hidden" id="userPanel" onclick="toggleMenu()">
      <div class="user-avatar" id="userAvatar">U</div>
    </div>
  </div>

  <!-- User menu -->
  <div class="user-menu hidden" id="userMenu">
    <div class="user-menu-item" onclick="verRecordatorios()">üìÖ Mis recordatorios</div>
    <div class="user-menu-item" onclick="mejorarPlan()">‚≠ê Mejorar plan</div>
    <div class="user-menu-item" onclick="logout()">üö™ Cerrar sesi√≥n</div>
  </div>

  <!-- Login hint -->
  <div class="login-hint hidden" id="loginHint">
    üîë Inicia sesi√≥n con Google para continuar
  </div>

  <!-- Google Sign In -->
  <div class="g_id_signin" 
       data-type="standard"
       data-shape="pill"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left"
       data-width="300">
  </div>

  <!-- Main area -->
  <div class="main-area" id="centerArea">
    <!-- AI Core -->
    <div class="ai-core" id="aiCore">
      <div class="core-text" id="coreText">GO</div>
    </div>
    
    <!-- Transcribed text -->
    <div class="transcribed-text" id="transcribedText"></div>
    
    <!-- Hint -->
    <div class="hint-text" id="hintText">
      Mant√©n presionado para hablar o usa el bot√≥n ‚úèÔ∏è para escribir
    </div>
  </div>

  <!-- Result panel -->
  <div class="result-panel" id="resultPanel"></div>

  <!-- Quick actions -->
  <div class="quick-actions hidden" id="quickActions">
    <button class="quick-btn" onclick="setQuickText('Agendame ')">üìù Agendar</button>
    <button class="quick-btn" onclick="setQuickText('Recordame ')">‚è∞ Recordar</button>
    <button class="quick-btn" onclick="setQuickText('Pasame ')">üîç Buscar</button>
  </div>

  <!-- Notif button -->
  <button class="notif-btn hidden" id="notifBtn" onclick="solicitarNotificaciones()">
    <svg class="icon"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
  </button>

  <!-- Text FAB -->
  <button class="text-fab" id="textFAB">
    <svg class="icon"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
  </button>

  <!-- Text modal -->
  <div class="text-modal hidden" id="textModal">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">Escribe tu solicitud</div>
      <textarea class="text-input" id="textInput" placeholder="Ej: Agendame reuni√≥n con Juan ma√±ana 15hs..."></textarea>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button class="modal-btn modal-btn-primary" id="sendTextBtn">
          <span id="sendBtnText">Enviar</span>
        </button>
      </div>
    </div>
  </div>

<script>
// ==================== VARIABLES GLOBALES ====================
let userEmail = null;
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingSeconds = 0;
let ultimoResultado = "";
let ultimoResultadoTexto = "";
let ultimoReminderData = null;
let modoEdicion = false;
let pushSubscription = null;
let pressTimer;
let isRecording = false;

// VAPID KEY
const VAPID_PUBLIC_KEY = 'BCEz3VvvDaXkZse_cMPmwS2s88ZTLiRshdRgLZZ7q2Fc5yCRkR9Y8nX1dmkw5tWvJhxABfLR7Ir8AsFF7CYJ7bw';

// DETECCI√ìN DE DISPOSITIVO
const ES_MOVIL = window.matchMedia('(pointer: coarse)').matches || window.innerWidth <= 768;
console.log('¬øEs m√≥vil?', ES_MOVIL);

// ==================== ELEMENTOS DOM ====================
const aiCore = document.getElementById("aiCore");
const coreText = document.getElementById("coreText");
const transcribedText = document.getElementById("transcribedText");
const resultPanel = document.getElementById("resultPanel");
const userPanel = document.getElementById("userPanel");
const userAvatar = document.getElementById("userAvatar");
const textFAB = document.getElementById("textFAB");
const textModal = document.getElementById("textModal");
const textInput = document.getElementById("textInput");
const sendTextBtn = document.getElementById("sendTextBtn");
const sendBtnText = document.getElementById("sendBtnText");
const modalTitle = document.getElementById("modalTitle");
const notifBtn = document.getElementById("notifBtn");
const quickActions = document.getElementById("quickActions");
const loginHint = document.getElementById("loginHint");
const userMenu = document.getElementById("userMenu");

// ==================== INICIALIZACI√ìN ====================
document.addEventListener('DOMContentLoaded', () => {
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registrado:', reg))
      .catch(err => console.log('SW error:', err));
  }
  
  // Escuchar mensajes del SW
  navigator.serviceWorker?.addEventListener('message', event => {
    if (event.data.type === 'REMINDER_TRIGGERED') {
      mostrarResultado(`‚è∞ Recordatorio: ${event.data.message}`, false);
      speak(`Recordatorio: ${event.data.message}`);
    }
  });
  
  // Cerrar men√∫ al hacer click fuera
  document.addEventListener('click', (e) => {
    if (!userPanel.contains(e.target) && !userMenu.contains(e.target)) {
      userMenu.classList.add('hidden');
    }
  });
  
  // Configurar bot√≥n seg√∫n dispositivo
  if (ES_MOVIL) {
    console.log('Configurando para M√ìVIL');
    configurarBotonMovil();
  } else {
    console.log('Configurando para DESKTOP');
    configurarBotonDesktop();
  }

  // Inactivity timer
  let inactivityTimer;
  const INACTIVITY_DELAY = 10000;
  const HINT_DURATION = 10000;

  function showHint() {
    const hint = document.getElementById('hintText');
    if (!hint || !userEmail) return;
    hint.classList.add('visible');
    hint.classList.remove('fade-out');
    setTimeout(() => {
      hint.classList.add('fade-out');
      hint.classList.remove('visible');
    }, HINT_DURATION);
  }

  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(showHint, INACTIVITY_DELAY);
    const hint = document.getElementById('hintText');
    if (hint && hint.classList.contains('visible')) {
      hint.classList.add('fade-out');
      hint.classList.remove('visible');
    }
  }

  ['click', 'touchstart', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, resetInactivity, { passive: true });
  });

  resetInactivity();
});

// ==================== BOT√ìN GO - M√ìVIL ====================
function configurarBotonMovil() {
  aiCore.replaceWith(aiCore.cloneNode(true));
  const nuevoAiCore = document.getElementById("aiCore");
  window.aiCore = nuevoAiCore;
  
  let touchIniciado = false;
  
  nuevoAiCore.addEventListener('touchstart', (e) => {
    e.preventDefault();
    console.log('M√ìVIL: touchstart');
    
    if (!userEmail) {
      toggleMenu();
      loginHint.classList.remove('hidden');
      setTimeout(() => speak("Debes iniciar sesi√≥n con Google para continuar."), 100);
      return;
    }
    
    touchIniciado = true;
    pressTimer = setTimeout(() => {
      if (touchIniciado) {
        isRecording = true;
        startRecording();
      }
    }, 200);
  }, {passive: false});

  nuevoAiCore.addEventListener('touchend', (e) => {
    e.preventDefault();
    touchIniciado = false;
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });

  nuevoAiCore.addEventListener('touchcancel', (e) => {
    e.preventDefault();
    touchIniciado = false;
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });
  
  nuevoAiCore.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    return false;
  }, true);
}

// ==================== BOT√ìN GO - DESKTOP ====================
function configurarBotonDesktop() {
  aiCore.addEventListener('mousedown', (e) => {
    if (!userEmail) {
      toggleMenu();
      loginHint.classList.remove('hidden');
      speak("Debes iniciar sesi√≥n con Google para continuar.");
      return;
    }
    
    pressTimer = setTimeout(() => {
      isRecording = true;
      startRecording();
    }, 200);
  });

  aiCore.addEventListener('mouseup', () => {
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });

  aiCore.addEventListener('mouseleave', () => {
    clearTimeout(pressTimer);
    if (isRecording) {
      isRecording = false;
      stopRecording();
    }
  });
  
  aiCore.addEventListener('click', (e) => {
    if (!userEmail) {
      toggleMenu();
      loginHint.classList.remove('hidden');
      speak("Debes iniciar sesi√≥n con Google para continuar.");
      return;
    }
    
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      startRecording();
    } else {
      stopRecording();
    }
  });
}

// ==================== AUTENTICACI√ìN ====================
function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = payload.email;

  userAvatar.textContent = payload.name
    ? payload.name.charAt(0).toUpperCase()
    : 'U';

  document.querySelector(".g_id_signin").classList.add("hidden");
  userPanel.classList.remove("hidden");
  userMenu.classList.add("hidden");
  loginHint.classList.add("hidden");
  notifBtn.classList.remove("hidden");
  quickActions.classList.remove("hidden");

  document.getElementById('centerArea').style.top = '73%';

  registrarPushSubscription();
}
  
async function registrarPushSubscription() {
  if (!userEmail) return;
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();

    if (subscription) {
      pushSubscription = subscription;
      notifBtn.classList.add("granted");
      notifBtn.innerHTML = '<svg class="icon"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      return;
    }

    notifBtn.classList.remove("granted");
    notifBtn.innerHTML = '<svg class="icon"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>';

  } catch (err) {
    console.error("Error:", err);
  }
}

function toggleMenu() {
  userMenu.classList.toggle("hidden");
}

function logout() {
  userEmail = null;
  userAvatar.textContent = "";
  userPanel.classList.add("hidden");
  document.querySelector(".g_id_signin").classList.remove("hidden");
  userMenu.classList.add("hidden");
  notifBtn.classList.add("hidden");
  quickActions.classList.add("hidden");

  transcribedText.textContent = "";
  resultPanel.innerHTML = "";
  resultPanel.classList.remove("show");
  loginHint.classList.remove("hidden");
  
  document.getElementById('centerArea').style.top = '50%';

  stopCoreAnimation();
  coreText.textContent = "GO";
  
  pushSubscription = null;
  
  if (window.google && window.google.accounts) {
    window.google.accounts.id.disableAutoSelect();
  }
}

function mejorarPlan() {
  userMenu.classList.add("hidden");
  mostrarResultado("Funci√≥n disponible pr√≥ximamente. ¬°Gracias por tu inter√©s!", false);
}

async function verRecordatorios() {
  userMenu.classList.add("hidden");
  if (!userEmail) return;
  
  startCoreAnimation("...");
  
  try {
    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: "listar recordatorios",
        email: userEmail
      })
    });
    
    const data = await res.json();
    if (data.result) {
      mostrarResultado(data.result, false);
    }
  } catch (err) {
    mostrarResultado("Error al cargar recordatorios", false);
  }
  
  stopCoreAnimation();
}

// ==================== NOTIFICACIONES PUSH ====================
async function solicitarNotificaciones() {
  if (!userEmail) {
    speak("Debes iniciar sesi√≥n primero");
    return;
  }

  try {
    const registration = await navigator.serviceWorker.ready;
    let subscription = await registration.pushManager.getSubscription();

    if (!subscription) {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        mostrarResultado("Necesitas permitir notificaciones", false);
        return;
      }

      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
    }

    pushSubscription = subscription;

    await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "registerPush",
        email: userEmail,
        subscription: subscription
      })
    });

    notifBtn.classList.add("granted");
    notifBtn.innerHTML = '<svg class="icon"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    mostrarResultado("Notificaciones activadas correctamente üîî", false);
    
  } catch (err) {
    console.error("Error activando notificaciones:", err);
    mostrarResultado("Error al activar notificaciones", false);
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

// ==================== VOZ ====================
function speak(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "es-AR";
  utterance.rate = 1;
  utterance.pitch = 1;
  startCoreAnimation("AI");
  utterance.onend = () => stopCoreAnimation();
  speechSynthesis.speak(utterance);
}

// ==================== ANIMACIONES ====================
function startCoreAnimation(label) {
  aiCore.classList.add("ai-active");
  
  if (label === "REC") {
    recordingSeconds = 0;
    coreText.innerHTML = `<span style="font-size:0.9rem">REC</span><br><span style="font-size:0.7rem">0s</span>`;
    recordingTimer = setInterval(() => {
      recordingSeconds++;
      coreText.innerHTML = `<span style="font-size:0.9rem">REC</span><br><span style="font-size:0.7rem">${recordingSeconds}s</span>`;
      
      if (recordingSeconds >= 30) {
        stopRecording();
      }
    }, 1000);
  } else if (label === "...") {
    coreText.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
  } else {
    coreText.textContent = label;
  }
}

function stopCoreAnimation() {
  aiCore.classList.remove("ai-active");
  clearInterval(recordingTimer);
  coreText.textContent = "GO";
}

// ==================== UI RESULTADOS - VERSI√ìN ACTUALIZADA ====================
function mostrarResultado(texto, mostrarEditar = false, esRecordatorio = false, reminderData = null, datosExtra = null) {
  // Si viene una lista de resultados (nuevo formato), usar la funci√≥n nueva
  if (typeof texto === 'object' && texto.resultados) {
    mostrarListaResultados(texto);
    return;
  }
  
  // C√≥digo anterior para un solo resultado (mantener compatibilidad)
  ultimoResultado = texto;
  ultimoResultadoTexto = texto.replace(/<[^>]*>/g, '').trim();
  
  if (reminderData && reminderData.isReminder) {
    ultimoReminderData = reminderData;
    console.log("‚úì Guardado reminderData (desde creaci√≥n):", ultimoReminderData);
  } else if (datosExtra && datosExtra.reminderId) {
    ultimoReminderData = {
      isReminder: true,
      id: datosExtra.reminderId,
      type: datosExtra.tipo || 'unico',
      dateText: datosExtra.dateText || '',
      timeText: datosExtra.timeText || '09:00',
      description: datosExtra.description || ultimoResultadoTexto
    };
    console.log("‚úì Guardado reminderData (desde b√∫squeda):", ultimoReminderData);
  } else if (!modoEdicion) {
    ultimoReminderData = null;
  }
  
  let html = `<div class="result-content">${texto}</div>`;
  
  if (esRecordatorio || (datosExtra && datosExtra.reminderId)) {
    html += `<div class="reminder-badge"><svg class="icon icon-small" style="stroke: currentColor;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Recordatorio programado</div>`;
  }
  
  if (mostrarEditar || (datosExtra && datosExtra.reminderId)) {
    html += `<button class="edit-btn" onclick="activarEdicion()"><svg class="icon icon-small" style="stroke: currentColor;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Editar</button>`;
  }
  
  resultPanel.innerHTML = html;
  resultPanel.classList.add("show");
  
  if (window.innerWidth <= 768) {
    resultPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// ========== NUEVA FUNCI√ìN: Mostrar lista de resultados ==========
function mostrarListaResultados(data) {
  const resultados = data.resultados;
  const total = data.total;
  
  console.log("Mostrando lista de", total, "resultados");
  
  let html = `<div class="resultados-lista">`;
  html += `<div class="resultados-header"><strong>Encontr√© ${total} resultado${total > 1 ? 's' : ''}</strong></div>`;
  
  resultados.forEach((r, index) => {
    const emoji = r.tipo === 'recordatorio' ? '‚è∞' : 'üìù';
    const color = r.tipo === 'recordatorio' ? '#ffc107' : '#666';
    
    html += `<div class="resultado-item" style="border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:10px; background:${r.tipo === 'recordatorio' ? '#fff8e1' : '#f5f5f5'};">`;
    
    // Contenido principal
    html += `<div style="font-weight:bold; margin-bottom:5px;">${emoji} ${r.contenido}</div>`;
    
    // Fecha y hora si existen
    if (r.fecha || r.hora) {
      html += `<div style="color:${color}; font-size:0.9em; margin-bottom:8px;">`;
      if (r.fecha) {
        const fecha = new Date(r.fecha);
        html += `üìÖ ${fecha.toLocaleDateString('es-ES', {day:'numeric', month:'short'})} `;
      }
      if (r.hora) {
        html += `üïê ${r.hora.replace(/:00$/, 'hs')}`;
      }
      html += `</div>`;
    }
    
    // Tipo (peque√±o)
    html += `<div style="color:#999; font-size:0.75em; text-transform:uppercase; margin-bottom:8px;">${r.tipo}</div>`;
    
    // Botones de acci√≥n
    html += `<div style="display:flex; gap:8px;">`;
    html += `<button onclick="editarResultado('${r.tipo}', '${r.id}', '${r.notaId || ''}', '${encodeURIComponent(r.contenido)}', '${r.fecha || ''}', '${r.hora || ''}')" style="flex:1; padding:6px 12px; border:none; border-radius:4px; background:#4CAF50; color:white; cursor:pointer; font-size:0.85em;">‚úèÔ∏è Editar</button>`;
    html += `<button onclick="eliminarResultado('${r.tipo}', '${r.id}', '${encodeURIComponent(r.contenido)}')" style="padding:6px 12px; border:none; border-radius:4px; background:#f44336; color:white; cursor:pointer; font-size:0.85em;">üóëÔ∏è</button>`;
    html += `</div>`;
    
    html += `</div>`;
  });
  
  html += `</div>`;
  
  resultPanel.innerHTML = html;
  resultPanel.classList.add("show");
  
  if (window.innerWidth <= 768) {
    resultPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// ========== NUEVA FUNCI√ìN: Editar resultado espec√≠fico ==========
function editarResultado(tipo, id, notaId, contenidoEncoded, fecha, hora) {
  const contenido = decodeURIComponent(contenidoEncoded);
  
  console.log("Editar:", { tipo, id, notaId, contenido, fecha, hora });
  
  // Guardar datos para edici√≥n
  window.datosEdicion = {
    tipo: tipo,
    id: id,
    notaId: notaId,
    contenidoOriginal: contenido,
    fechaOriginal: fecha,
    horaOriginal: hora
  };
  
  // Preparar modal
  modoEdicion = true;
  
  if (tipo === 'recordatorio') {
    // Reconstruir texto de recordatorio
    const fechaTexto = fecha ? new Date(fecha).toLocaleDateString('es-ES', {day:'numeric', month:'long'}) : 'ma√±ana';
    const horaTexto = hora ? hora.replace(/:00$/, 'hs') : '';
    textInput.value = `Recordame ${fechaTexto} ${horaTexto ? 'a las ' + horaTexto : ''} ${contenido}`.trim();
    modalTitle.textContent = "Editar recordatorio";
  } else {
    // Agenda simple
    textInput.value = contenido;
    modalTitle.textContent = "Editar agenda";
  }
  
  sendBtnText.textContent = "Guardar cambios";
  textModal.classList.remove("hidden");
  textInput.focus();
  textInput.select();
}

// ========== NUEVA FUNCI√ìN: Eliminar resultado espec√≠fico ==========
async function eliminarResultado(tipo, id, contenidoEncoded) {
  const contenido = decodeURIComponent(contenidoEncoded);
  
  if (!confirm(`¬øEliminar "${contenido}"?`)) return;
  
  try {
    startCoreAnimation("...");
    
    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "delete",
        text: contenido,
        email: userEmail,
        userId: userEmail
      })
    });
    
    const data = await res.json();
    
    if (data.ok) {
      mostrarResultado(`‚úÖ Eliminado: ${contenido}`, false);
    } else {
      mostrarResultado(`‚ùå No se pudo eliminar`, false);
    }
    
  } catch (err) {
    console.error("Error eliminando:", err);
    mostrarResultado("Error de conexi√≥n", false);
  }
  
  stopCoreAnimation();
}

function activarEdicion() {
  console.log("=== ACTIVAR EDICI√ìN ===");
  console.log("ultimoResultadoTexto:", ultimoResultadoTexto);
  console.log("ultimoReminderData:", ultimoReminderData);
  
  if (!ultimoResultadoTexto) {
    console.error("No hay texto para editar");
    return;
  }
  
  modoEdicion = true;
  
  if (ultimoReminderData && ultimoReminderData.isReminder) {
    const tipo = ultimoReminderData.type || 'unico';
    const fecha = ultimoReminderData.dateText || 'ma√±ana';
    const hora = ultimoReminderData.timeText || '09:00';
    const descripcion = ultimoReminderData.description || ultimoResultadoTexto;
    
    const horaBonita = hora.replace(/:00$/, 'hs').replace(/:(\d+)$/, ':$1');
    
    textInput.value = `Recordame ${fecha} a las ${horaBonita} ${descripcion}`;
    modalTitle.textContent = "Editar recordatorio";
    sendBtnText.textContent = "Guardar cambios";
    
    console.log("Texto reconstruido para edici√≥n:", textInput.value);
    console.log("ID del recordatorio a editar:", ultimoReminderData.id);
  } else {
    textInput.value = ultimoResultadoTexto;
    modalTitle.textContent = "Editar nota";
    sendBtnText.textContent = "Guardar cambios";
    console.log("Edici√≥n normal (sin ID de recordatorio):", textInput.value);
  }
  
  textModal.classList.remove("hidden");
  textInput.focus();
  textInput.select();
}

function setQuickText(texto) {
  if (!userEmail) {
    toggleMenu();
    return;
  }
  modoEdicion = false;
  textInput.value = texto;
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
  textModal.classList.remove("hidden");
  textInput.focus();
}

// ==================== MODAL TEXTO ====================
textFAB.onclick = () => {
  if (!userEmail) {
    toggleMenu();
    loginHint.classList.remove("hidden");
    speak("Debes iniciar sesi√≥n con Google para continuar.");
    return;
  }

  modoEdicion = false;
  ultimoReminderData = null;
  textInput.value = "";
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
  textModal.classList.remove("hidden");
  textInput.focus();
};

textModal.onclick = (e) => {
  if (e.target === textModal) {
    cerrarModal();
  }
};

textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    cerrarModal();
  }
  if (e.key === 'Enter' && e.ctrlKey) {
    sendTextBtn.click();
  }
});

function cerrarModal() {
  textModal.classList.add("hidden");
  modoEdicion = false;
  textInput.value = "";
  modalTitle.textContent = "Escribe tu solicitud";
  sendBtnText.textContent = "Enviar";
}

// ==================== ENVIAR TEXTO - ACTUALIZADO ====================
sendTextBtn.onclick = async () => {
  const texto = textInput.value.trim();
  if (!texto) return;

  const esEdicion = modoEdicion;
  const reminderActual = ultimoReminderData;

  console.log("=== ENVIAR TEXTO ===");
  console.log("esEdicion:", esEdicion);
  console.log("texto:", texto);

  cerrarModal();
  
  transcribedText.textContent = esEdicion ? `Editando: ${texto}` : texto;

  try {
    startCoreAnimation("...");

    if (esEdicion && reminderActual && reminderActual.id) {
      console.log("=== EDICI√ìN: Borrando viejo ===");
      
      await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "delete",
          text: reminderActual.description,
          email: userEmail,
          userId: userEmail
        })
      });
      
      const res = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: texto,
          email: userEmail,
          userId: userEmail
        })
      });
      
      const data = await res.json();
      if (data.ok) {
        mostrarResultado(data, false); // Nuevo formato
      }
      
      if (data.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${data.audioBase64}`);
        startCoreAnimation("AI");
        audio.play();
        audio.onended = () => stopCoreAnimation();
      } else {
        stopCoreAnimation();
      }
      
      return;
    }

    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: texto,
        email: userEmail,
        userId: userEmail
      })
    });

    const data = await res.json();
    modoEdicion = false;

    // ========== NUEVO: Detectar lista de resultados ==========
    if (data.resultados && data.resultados.length > 0) {
      mostrarResultado(data, false);
      speak(data.text || `Encontr√© ${data.total} resultados`);
    } else if (data.result) {
      // Formato antiguo: un solo resultado
      const esBusqueda = data.action === "get" && !data.result.toLowerCase().includes("no encontr");
      const esRecordatorio = data.reminderData && data.reminderData.isReminder;
      
      const datosExtra = data.reminderId ? {
        reminderId: data.reminderId,
        tipo: data.tipo,
        dateText: data.dateText,
        timeText: data.timeText,
        description: data.description
      } : null;
      
      mostrarResultado(data.result, esBusqueda, esRecordatorio, data.reminderData, datosExtra);
      speak(data.text || data.result.replace(/<[^>]*>/g, ''));
    }

    if (data.ok && data.audioBase64) {
      const audio = new Audio(`data:audio/mpeg;base64,${data.audioBase64}`);
      startCoreAnimation("AI");
      audio.play();
      audio.onended = () => stopCoreAnimation();
    } else {
      stopCoreAnimation();
    }

  } catch (err) {
    console.error("Error:", err);
    mostrarResultado("Error de conexi√≥n. Intenta de nuevo.", false);
    stopCoreAnimation();
    modoEdicion = false;
  }
};

// ==================== GRABACI√ìN DE VOZ - ACTUALIZADO ====================
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });
    
    const options = { mimeType: 'audio/webm;codecs=opus' };
    mediaRecorder = new MediaRecorder(stream, options);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };
    
    mediaRecorder.onstop = sendAudio;
    mediaRecorder.start(100);
    
    startCoreAnimation("REC");
  } catch(err) {
    console.error(err);
    mostrarResultado("Error al acceder al micr√≥fono. Verifica los permisos.", false);
    speak("No puedo acceder al micr√≥fono");
    isRecording = false;
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
    stopCoreAnimation();
  }
}

async function sendAudio() {
  if (audioChunks.length === 0) return;
  
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const reader = new FileReader();
  reader.readAsDataURL(blob);

  reader.onloadend = async () => {
    const base64 = reader.result.split(",")[1];

    try {
      startCoreAnimation("...");

      const resTrans = await fetch("/.netlify/functions/transcribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ audio: base64 })
      });

      const dataTrans = await resTrans.json();
      
      if (!dataTrans.text) {
        throw new Error("No se pudo transcribir el audio");
      }
      
      const texto = dataTrans.text;
      transcribedText.textContent = texto;

      const resResp = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: texto,
          email: userEmail
        })
      });

      const dataResp = await resResp.json();

      // ========== NUEVO: Detectar lista de resultados ==========
      if (dataResp.resultados && dataResp.resultados.length > 0) {
        mostrarResultado(dataResp, false);
        speak(dataResp.text || `Encontr√© ${dataResp.total} resultados`);
      } else if (dataResp.result) {
        const esBusqueda = dataResp.action === "get" && !dataResp.result.toLowerCase().includes("no encontr");
        const esRecordatorio = dataResp.reminderData && dataResp.reminderData.isReminder;
        
        const datosExtra = dataResp.reminderId ? {
          reminderId: dataResp.reminderId,
          tipo: dataResp.tipo,
          dateText: dataResp.dateText,
          timeText: dataResp.timeText,
          description: dataResp.description
        } : null;
        
        mostrarResultado(dataResp.result, esBusqueda, esRecordatorio, dataResp.reminderData, datosExtra);
        speak(dataResp.text || dataResp.result.replace(/<[^>]*>/g, ''));
      }

      if (dataResp.ok && dataResp.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${dataResp.audioBase64}`);
        startCoreAnimation("AI");
        audio.play();
        audio.onended = () => stopCoreAnimation();
      } else {
        stopCoreAnimation();
      }

    } catch (err) {
      console.error(err);
      transcribedText.textContent = "[Error de procesamiento]";
      mostrarResultado("No pude procesar tu solicitud. Intenta de nuevo.", false);
      stopCoreAnimation();
    }
  };
  
  reader.onerror = () => {
    transcribedText.textContent = "[Error de lectura]";
    stopCoreAnimation();
  };
}

</script>
</body>
</html>
