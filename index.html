<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automatic Life</title>

<!-- Google Identity -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  font-family: 'Segoe UI', Arial, sans-serif;
  color: #00ffea;
  overflow: hidden;
}

/* Top Bar */
#topBar {
  position: absolute;
  top: 20px;
  right: 30px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 100;
}

#userPanel {
  cursor: pointer;
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 0.9rem;
  background: rgba(0,255,234,0.1);
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid rgba(0,255,234,0.3);
  transition: all 0.3s;
}

#userPanel:hover {
  background: rgba(0,255,234,0.2);
  box-shadow: 0 0 15px rgba(0,255,234,0.3);
}

.planBadge {
  background: rgba(0,255,234,0.2);
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid #00ffea;
  font-size: 0.7rem;
  font-weight: bold;
}

#userMenu {
  position: absolute;
  top: 50px;
  right: 0;
  background: rgba(15, 12, 41, 0.95);
  border: 1px solid #00ffea;
  padding: 15px;
  border-radius: 12px;
  min-width: 180px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

#userMenu div {
  padding: 10px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  margin-bottom: 5px;
}

#userMenu div:hover {
  background: rgba(0,255,234,0.1);
}

#userMenu div:last-child {
  margin-bottom: 0;
  color: #ff6b6b;
}

.hidden { display: none !important; }

/* Result panel */
#resultPanel {
  margin-bottom: 100px;
  padding: 20px;
  width: 90%;
  max-width: 600px;
  min-height: 60px;
  border: 2px solid rgba(0,255,234,0.3);
  border-radius: 20px;
  background: rgba(0,255,234,0.05);
  backdrop-filter: blur(10px);
  opacity: 0;
  transition: all 0.4s ease;
  text-align: center;
  font-size: 1.1rem;
  line-height: 1.6;
  max-height: 300px;
  overflow-y: auto;
}

#resultPanel.show { 
  opacity: 1; 
  transform: translateY(0);
}

#resultPanel::-webkit-scrollbar {
  width: 8px;
}

#resultPanel::-webkit-scrollbar-track {
  background: rgba(0,255,234,0.1);
  border-radius: 4px;
}

#resultPanel::-webkit-scrollbar-thumb {
  background: #00ffea;
  border-radius: 4px;
}

/* GO button */
#aiCore {
  position: relative;
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: radial-gradient(circle, #00ffea 0%, #00c4b4 70%, #003a38 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  box-shadow:
    0 0 30px #00ffea,
    0 0 60px rgba(0,255,234,0.5),
    inset 0 0 20px rgba(255,255,255,0.2);
  transition: all 0.3s ease;
  user-select: none;
}

#aiCore:hover {
  transform: scale(1.05);
  box-shadow:
    0 0 40px #00ffea,
    0 0 80px rgba(0,255,234,0.6);
}

#aiCore:active {
  transform: scale(0.95);
}

#coreText {
  color: #001a18;
  font-weight: bold;
  font-size: 1.4rem;
  letter-spacing: 3px;
  pointer-events: none;
}

.pulseRing {
  position: absolute;
  width: 150px;
  height: 150px;
  border: 3px solid #00ffea;
  border-radius: 50%;
  opacity: 0;
  pointer-events: none;
}

.ai-active .pulseRing {
  animation: pulseWave 1.5s infinite;
}

.pulseRing:nth-child(1) {
  animation-delay: 0s;
}
.pulseRing:nth-child(2) {
  animation-delay: 0.5s;
}
.pulseRing:nth-child(3) {
  animation-delay: 1s;
}

@keyframes pulseWave {
  0% {
    transform: scale(1);
    opacity: 0.8;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

#transcribedText {
  display: block;
  margin-top: 30px;
  font-size: 0.95rem;
  letter-spacing: 1px;
  opacity: 0.7;
  color: #00ffea;
  min-height: 20px;
  font-style: italic;
}

#loginHint {
  font-size: 14px;
  opacity: 0.8;
  margin-top: 20px;
  padding: 10px 20px;
  background: rgba(255,107,107,0.1);
  border: 1px solid rgba(255,107,107,0.3);
  border-radius: 20px;
  color: #ff6b6b;
}

/* Notification permission button */
#notifBtn {
  position: fixed;
  bottom: 100px;
  right: 30px;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: rgba(0,255,234,0.1);
  border: 2px solid #00ffea;
  color: #00ffea;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s;
  z-index: 50;
}

#notifBtn:hover {
  background: rgba(0,255,234,0.2);
  transform: scale(1.1);
}

#notifBtn.granted {
  background: #00ffea;
  color: #001a18;
}

/* Floating button */
#textFAB {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: #00ffea;
  color: #001a18;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 0 20px #00ffea;
  transition: all 0.3s;
  z-index: 50;
}

#textFAB:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 0 30px #00ffea;
}

/* Modal */
#textModal {
  position: fixed;
  inset: 0;
  background: rgba(5, 10, 25, 0.85);
  backdrop-filter: blur(15px);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

#textModal:not(.hidden) {
  display: flex;
  opacity: 1;
  pointer-events: all;
}

#textBox {
  background: rgba(0,255,234,0.05);
  border: 1px solid rgba(0,255,234,0.4);
  box-shadow:
    0 0 30px rgba(0,255,234,0.3),
    0 0 60px rgba(0,255,234,0.1);
  border-radius: 20px;
  padding: 30px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  backdrop-filter: blur(20px);
  transform: scale(0.9);
  transition: transform 0.3s;
}

#textModal:not(.hidden) #textBox {
  transform: scale(1);
}

#textInput {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(0,255,234,0.5);
  border-radius: 12px;
  padding: 15px;
  color: #00ffea;
  font-size: 16px;
  resize: none;
  outline: none;
  height: 120px;
  font-family: inherit;
  transition: all 0.3s;
}

#textInput::placeholder {
  color: rgba(0,255,234,0.4);
}

#textInput:focus {
  border-color: #00ffea;
  box-shadow: 0 0 20px rgba(0,255,234,0.3);
  background: rgba(0,0,0,0.5);
}

#sendTextBtn {
  background: radial-gradient(circle, #00ffea 0%, #00c4b4 100%);
  border: none;
  border-radius: 30px;
  padding: 15px;
  font-weight: bold;
  letter-spacing: 2px;
  color: #001a18;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0,255,234,0.5);
  transition: all 0.3s;
  font-size: 1rem;
  text-transform: uppercase;
}

#sendTextBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 25px rgba(0,255,234,0.7);
}

#sendTextBtn:active {
  transform: translateY(0);
}

/* Quick actions */
#quickActions {
  position: fixed;
  bottom: 30px;
  left: 30px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 50;
}

.quickBtn {
  background: rgba(0,255,234,0.1);
  border: 1px solid rgba(0,255,234,0.3);
  color: #00ffea;
  padding: 10px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.3s;
  backdrop-filter: blur(5px);
}

.quickBtn:hover {
  background: rgba(0,255,234,0.2);
  transform: translateX(5px);
}

/* Loading dots */
.loading-dots {
  display: inline-flex;
  gap: 4px;
}

.loading-dots span {
  animation: bounce 1.4s infinite ease-in-out both;
  background: #00ffea;
  border-radius: 50%;
  width: 8px;
  height: 8px;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Reminder badge */
.reminder-badge {
  display: inline-block;
  background: rgba(255,193,7,0.2);
  border: 1px solid #ffc107;
  color: #ffc107;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  margin-top: 10px;
}

/* Edit button */
.edit-btn {
  margin-top: 15px;
  padding: 8px 20px;
  border-radius: 20px;
  border: none;
  background: #00ffea;
  cursor: pointer;
  font-weight: bold;
  color: #001a18;
  transition: all 0.3s;
}

.edit-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(0,255,234,0.5);
}
</style>
</head>

<body>

<!-- Google auto loader -->
<div id="g_id_onload"
     data-client_id="687016135689-g9holcsj91ptukrlhr9a9bo23sroaun3.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
</div>

<!-- TOP BAR -->
<div id="topBar">
  <!-- User Panel -->
  <div id="userPanel" class="hidden" onclick="toggleMenu()">
    <span id="userEmail"></span>
    <span class="planBadge">Free</span>
  </div>

  <!-- User Menu -->
  <div id="userMenu" class="hidden">
    <div class="g_id_signin"
         data-type="standard"
         data-theme="outline"
         data-size="medium">
    </div>
    <div onclick="mejorarPlan()">‚≠ê Mejorar Plan</div>
    <div onclick="verRecordatorios()">üìÖ Mis Recordatorios</div>
    <div onclick="logout()">üö™ Cerrar sesi√≥n</div>
  </div>
</div>

<!-- NOTIFICATION BUTTON -->
<button id="notifBtn" class="hidden" onclick="solicitarNotificaciones()" title="Activar notificaciones">üîî</button>

<!-- RESULT PANEL -->
<div id="resultPanel"></div>

<!-- AI CORE -->
<div id="aiCore">
  <div class="pulseRing"></div>
  <div class="pulseRing"></div>
  <div class="pulseRing"></div>
  <div id="coreText">GO</div>
</div>

<p><span id="transcribedText"></span></p>
<p id="loginHint" class="hidden">üîê Inicia sesi√≥n con Google para usar Automatic Life</p>

<!-- QUICK ACTIONS -->
<div id="quickActions" class="hidden">
  <button class="quickBtn" onclick="setQuickText('Recordame ma√±ana a las ')">‚è∞ Ma√±ana</button>
  <button class="quickBtn" onclick="setQuickText('Agendame ')">üìù Agendar</button>
  <button class="quickBtn" onclick="setQuickText('Pasame ')">üîç Buscar</button>
</div>

<!-- TEXT FAB -->
<div id="textFAB">‚úèÔ∏è</div>

<!-- TEXT MODAL -->
<div id="textModal" class="hidden">
  <div id="textBox">
    <textarea id="textInput" placeholder="Escribe tu solicitud... Ej: Recordame ma√±ana a las 9:00 llamar al m√©dico"></textarea>
    <button id="sendTextBtn">Enviar</button>
  </div>
</div>

<script>
// ==================== VARIABLES GLOBALES ====================
let userEmail = null;
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingSeconds = 0;
let ultimoResultado = "";
let modoEdicion = false;
let pushSubscription = null;

// ==================== ELEMENTOS DOM ====================
const aiCore = document.getElementById("aiCore");
const coreText = document.getElementById("coreText");
const transcribedText = document.getElementById("transcribedText");
const resultPanel = document.getElementById("resultPanel");
const userEmailSpan = document.getElementById("userEmail");
const textFAB = document.getElementById("textFAB");
const textModal = document.getElementById("textModal");
const textInput = document.getElementById("textInput");
const sendTextBtn = document.getElementById("sendTextBtn");
const notifBtn = document.getElementById("notifBtn");
const quickActions = document.getElementById("quickActions");

// ==================== INICIALIZACI√ìN ====================
document.addEventListener('DOMContentLoaded', () => {
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registrado:', reg))
      .catch(err => console.log('SW error:', err));
  }
  
  // Escuchar mensajes del SW
  navigator.serviceWorker?.addEventListener('message', event => {
    if (event.data.type === 'REMINDER_TRIGGERED') {
      mostrarResultado(`üîî Recordatorio: ${event.data.message}`, false);
      speak(`Recordatorio: ${event.data.message}`);
    }
  });
});

// ==================== AUTENTICACI√ìN ====================
function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  userEmail = payload.email;
  userEmailSpan.textContent = userEmail;

  document.querySelector(".g_id_signin").classList.add("hidden");
  document.getElementById("userPanel").classList.remove("hidden");
  document.getElementById("userMenu").classList.add("hidden");
  document.getElementById("loginHint").classList.add("hidden");
  notifBtn.classList.remove("hidden");
  quickActions.classList.remove("hidden");
  
  // Registrar suscripci√≥n push si ya existe
  registrarPushSubscription();
}

function toggleMenu() {
  document.getElementById("userMenu").classList.toggle("hidden");
}

function logout() {
  userEmail = null;
  userEmailSpan.textContent = "";
  document.getElementById("userPanel").classList.add("hidden");
  document.querySelector(".g_id_signin").classList.remove("hidden");
  document.getElementById("userMenu").classList.add("hidden");
  notifBtn.classList.add("hidden");
  quickActions.classList.add("hidden");

  transcribedText.textContent = "";
  resultPanel.innerHTML = "";
  resultPanel.classList.remove("show");
  document.getElementById("loginHint").classList.remove("hidden");

  stopCoreAnimation();
  coreText.textContent = "GO";
  
  // Limpiar suscripci√≥n push
  pushSubscription = null;
}

function mejorarPlan() {
  mostrarResultado("‚≠ê Funci√≥n disponible pr√≥ximamente. ¬°Gracias por tu inter√©s!", false);
}

async function verRecordatorios() {
  if (!userEmail) return;
  
  startCoreAnimation("...");
  
  try {
    const res = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: "listar recordatorios",
        email: userEmail
      })
    });
    
    const data = await res.json();
    if (data.result) {
      mostrarResultado(data.result, false);
    }
  } catch (err) {
    mostrarResultado("Error al cargar recordatorios", false);
  }
  
  stopCoreAnimation();
}

// ==================== NOTIFICACIONES PUSH ====================
async function solicitarNotificaciones() {
  if (!userEmail) {
    speak("Debes iniciar sesi√≥n primero");
    return;
  }
  
  if (!('Notification' in window)) {
    mostrarResultado("Tu navegador no soporta notificaciones", false);
    return;
  }
  
  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    notifBtn.classList.add('granted');
    notifBtn.innerHTML = '‚úì';
    await subscribeToPush();
  } else {
    mostrarResultado("Necesitas permitir notificaciones para los recordatorios", false);
  }
}

async function subscribeToPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array('BK3d7LKjB2vKLxJ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ8mQ=') // Reemplaza con tu clave VAPID p√∫blica
    });
    
    pushSubscription = subscription;
    
    // Enviar al servidor
    await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "registerPush",
        email: userEmail,
        subscription: subscription
      })
    });
    
    mostrarResultado("‚úÖ Notificaciones activadas correctamente", false);
  } catch (err) {
    console.error('Error suscripci√≥n push:', err);
  }
}

async function registrarPushSubscription() {
  if (!userEmail) return;
  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.getSubscription();
  if (subscription) {
    pushSubscription = subscription;
    notifBtn.classList.add('granted');
    notifBtn.innerHTML = '‚úì';
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

// ==================== VOZ ====================
function speak(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "es-AR";
  utterance.rate = 1;
  utterance.pitch = 1;
  startCoreAnimation("AI");
  utterance.onend = () => stopCoreAnimation();
  speechSynthesis.speak(utterance);
}

// ==================== ANIMACIONES ====================
function startCoreAnimation(label) {
  aiCore.classList.add("ai-active");
  
  if (label === "REC") {
    recordingSeconds = 0;
    coreText.innerHTML = `REC <span style="font-size:0.8rem">0s</span>`;
    recordingTimer = setInterval(() => {
      recordingSeconds++;
      coreText.innerHTML = `REC <span style="font-size:0.8rem">${recordingSeconds}s</span>`;
      
      // Auto-stop despu√©s de 30 segundos
      if (recordingSeconds >= 30) {
        aiCore.click();
      }
    }, 1000);
  } else if (label === "...") {
    coreText.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
  } else {
    coreText.textContent = label;
  }
}

function stopCoreAnimation() {
  aiCore.classList.remove("ai-active");
  clearInterval(recordingTimer);
  coreText.textContent = "GO";
}

// ==================== UI RESULTADOS ====================
function mostrarResultado(texto, mostrarEditar = false, esRecordatorio = false) {
  ultimoResultado = texto;
  
  let html = `<div>${texto}</div>`;
  
  if (esRecordatorio) {
    html += `<div class="reminder-badge">‚è∞ Recordatorio programado</div>`;
  }
  
  if (mostrarEditar) {
    html += `<button class="edit-btn" onclick="activarEdicion()">‚úèÔ∏è Editar</button>`;
  }
  
  resultPanel.innerHTML = html;
  resultPanel.classList.add("show");
}

function activarEdicion() {
  modoEdicion = true;
  textInput.value = ultimoResultado;
  textModal.classList.remove("hidden");
  textInput.focus();
}

function setQuickText(texto) {
  if (!userEmail) {
    document.getElementById("userMenu").classList.remove("hidden");
    return;
  }
  textInput.value = texto;
  textModal.classList.remove("hidden");
  textInput.focus();
}

// ==================== MODAL TEXTO ====================
textFAB.onclick = () => {
  if (!userEmail) {
    document.getElementById("userMenu").classList.remove("hidden");
    document.getElementById("loginHint").classList.remove("hidden");
    speak("Debes iniciar sesi√≥n con Google para continuar.");
    return;
  }

  modoEdicion = false;
  textInput.value = "";
  textModal.classList.remove("hidden");
  textInput.focus();
};

textModal.onclick = (e) => {
  if (e.target === textModal) {
    cerrarModal();
  }
};

textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    cerrarModal();
  }
  if (e.key === 'Enter' && e.ctrlKey) {
    sendTextBtn.click();
  }
});

function cerrarModal() {
  textModal.classList.add("hidden");
  modoEdicion = false;
  textInput.value = "";
}

// ==================== ENVIAR TEXTO ====================
sendTextBtn.onclick = async () => {
  const texto = textInput.value.trim();
  if (!texto) return;

  cerrarModal();
  transcribedText.textContent = texto;

  try {
    startCoreAnimation("...");

    let bodyData;

    if (modoEdicion) {
      bodyData = {
        action: "edit",
        oldText: ultimoResultado,
        newText: texto,
        email: userEmail
      };
    } else {
      bodyData = {
        text: texto,
        email: userEmail
      };
    }

    const resResp = await fetch("/.netlify/functions/respond", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyData)
    });

    const dataResp = await resResp.json();

    if (dataResp.result) {
      const esBusqueda = dataResp.action === "get" && !dataResp.result.toLowerCase().includes("no encontr");
      const esRecordatorio = dataResp.reminderData || false;
      
      mostrarResultado(dataResp.result, esBusqueda, esRecordatorio);
    }

    if (dataResp.ok && dataResp.audioBase64) {
      const audio = new Audio(`data:audio/mpeg;base64,${dataResp.audioBase64}`);
      startCoreAnimation("AI");
      audio.play();
      audio.onended = () => stopCoreAnimation();
    } else {
      stopCoreAnimation();
    }

  } catch (err) {
    console.error(err);
    mostrarResultado("Error de conexi√≥n. Intenta de nuevo.", false);
    stopCoreAnimation();
  }
};

// ==================== GRABACI√ìN DE VOZ ====================
aiCore.onclick = async () => {
  if (!userEmail) {
    document.getElementById("userMenu").classList.remove("hidden");
    document.getElementById("loginHint").classList.remove("hidden");
    speak("Debes iniciar sesi√≥n con Google para continuar.");
    return;
  }

  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        } 
      });
      
      const options = { mimeType: 'audio/webm;codecs=opus' };
      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];
      
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };
      
      mediaRecorder.onstop = sendAudio;
      mediaRecorder.start(100); // Collect data every 100ms
      
      startCoreAnimation("REC");
    } catch(err) {
      console.error(err);
      mostrarResultado("Error al acceder al micr√≥fono. Verifica los permisos.", false);
      speak("No puedo acceder al micr√≥fono");
    }
  } else {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
    stopCoreAnimation();
  }
};

async function sendAudio() {
  if (audioChunks.length === 0) return;
  
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const reader = new FileReader();
  reader.readAsDataURL(blob);

  reader.onloadend = async () => {
    const base64 = reader.result.split(",")[1];

    try {
      startCoreAnimation("...");

      // Transcribir
      const resTrans = await fetch("/.netlify/functions/transcribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ audio: base64 })
      });

      const dataTrans = await resTrans.json();
      
      if (!dataTrans.text) {
        throw new Error("No se pudo transcribir el audio");
      }
      
      const texto = dataTrans.text;
      transcribedText.textContent = texto;

      // Procesar
      const resResp = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: texto,
          email: userEmail
        })
      });

      const dataResp = await resResp.json();

      if (dataResp.result) {
        const esBusqueda = dataResp.action === "get" && !dataResp.result.toLowerCase().includes("no encontr");
        const esRecordatorio = dataResp.reminderData || false;
        
        mostrarResultado(dataResp.result, esBusqueda, esRecordatorio);
      }

      if (dataResp.ok && dataResp.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${dataResp.audioBase64}`);
        startCoreAnimation("AI");
        audio.play();
        audio.onended = () => stopCoreAnimation();
      } else {
        stopCoreAnimation();
      }

    } catch (err) {
      console.error(err);
      transcribedText.textContent = "[Error de procesamiento]";
      mostrarResultado("No pude procesar tu solicitud. Intenta de nuevo.", false);
      stopCoreAnimation();
    }
  };
  
  reader.onerror = () => {
    transcribedText.textContent = "[Error de lectura]";
    stopCoreAnimation();
  };
}
</script>
</body>
</html>
