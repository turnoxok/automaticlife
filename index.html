<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Automatic Life</title>
</head>
<body>
  <h1>Automatic Life</h1>
  <button id="startBtn">Grabar</button>
  <p>Texto: <span id="transcribedText"></span></p>

  <script>
async function sendAudio() {
  const blob = new Blob(audioChunks, { type: "audio/webm" });
  const reader = new FileReader();
  reader.readAsDataURL(blob);
  reader.onloadend = async () => {
    console.log("Audio base64:", reader.result?.slice(0,100), "..."); // debug

    if (!reader.result) return console.error("Error leyendo audio");

    const base64 = reader.result.split(",")[1];

    // 1️⃣ Transcribir
    const resTrans = await fetch("/.netlify/functions/transcribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audioBase64: base64 })
    });

    const dataTrans = await resTrans.json();
    console.log("Respuesta transcribe:", dataTrans);

    transcribedText.textContent = dataTrans.text || "[Error de transcripción]";

    // 2️⃣ Responder con voz solo si hay texto
    if (dataTrans.text) {
      console.log("Enviando a respond.js:", dataTrans.text);
      const resResp = await fetch("/.netlify/functions/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: `Te agendé: ${dataTrans.text}` })
      });
      const dataResp = await resResp.json();
      console.log("Respuesta respond:", dataResp);
      if (dataResp.ok && dataResp.audioBase64) {
        const audio = new Audio(`data:audio/mpeg;base64,${dataResp.audioBase64}`);
        audio.play();
      }
    }
  };
}
</script></body>
</html>
